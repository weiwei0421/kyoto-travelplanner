<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025年大阪京都之旅</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet Map CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- SortableJS (New for Drag & Drop) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Google Fonts: M PLUS Rounded 1c -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <!-- Custom Handwriting Font -->
    <link href="https://cdn.jsdelivr.net/npm/chenyuluoyan-thin@1.0.0/chenyuluoyan.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#f8fafc',        
                        sidebar: '#ffffff',   
                        card: '#ffffff',      
                        gold: '#d4b165',      
                        'gold-dim': '#f0e6cf',
                        text: '#1e293b',      
                        sub: '#64748b',       
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'glow': '0 0 15px rgba(212, 177, 101, 0.4)',
                    },
fontFamily: {
                        // 主要字體：圓體 -> 思源黑體 -> 微軟正黑體 -> 系統預設
                        sans: ['"M PLUS Rounded 1c"', '"Noto Sans TC"', '"Microsoft JhengHei"', '"Heiti TC"', 'sans-serif'],
                        
                        // 手寫字體：快樂體 -> 圓體 -> 系統預設
                        hand: ['"ZCOOL KuaiLe"', '"M PLUS Rounded 1c"', 'cursive'],
                        
                        // 等寬字體 (數字/代碼用)
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    }              
                      }
            }
        }
    </script>
    
    <style>
        body {
            background-color: #f1f5f9;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            font-family: "M PLUS Rounded 1c", sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #map-container { height: 250px; width: 100%; z-index: 1; border-radius: 1rem; }
        
        /* Drag & Drop Styles */
        .sortable-ghost { opacity: 0.4; background-color: #fef9c3; border: 2px dashed #d4b165; }
        .sortable-drag { opacity: 1; transform: scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }

        /* Ticket Rips */
        .ticket-rip {
            position: absolute;
            height: 20px;
            width: 20px;
            background-color: #f8fafc;
            border-radius: 50%;
            z-index: 10;
        }
        .ticket-rip-memories {
            position: absolute;
            height: 16px;
            width: 16px;
            background-color: #f1f5f9;
            border-radius: 50%;
            z-index: 10;
        }

        /* --- NEW FANCY INPUT STYLES (UI Polish) --- */
        .input-fancy-group {
            background-color: #f8fafc;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            margin-bottom: 0.5rem;
        }
        .input-fancy-group:focus-within {
            background-color: #ffffff;
            box-shadow: 0 4px 20px -5px rgba(0,0,0,0.1);
            border-color: #e2e8f0;
            transform: translateY(-1px);
        }
        .input-fancy-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 800;
            color: #94a3b8;
            margin-bottom: 0.2rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .input-fancy {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-size: 0.95rem;
            color: #334155;
            font-weight: 700;
            padding: 0;
        }
        .input-fancy::placeholder { color: #cbd5e1; font-weight: 500; }
        select.input-fancy { background-color: transparent; }

        /* Legacy input support just in case */
        .input-light {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #334155;
            transition: all 0.2s;
        }
        .input-light:focus {
            border-color: #d4b165;
            background-color: #fff;
            outline: none;
        }
        
        .book-page {
            background-color: #ffffff;
            border: 1px solid #f1f5f9;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1), 
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 0 40px rgba(0,0,0,0.02);
        }

        .stamp-box {
            border: 3px double #9f1239;
            color: #9f1239;
            transform: rotate(-10deg);
            opacity: 0.85;
            mask-image: url('https://upload.wikimedia.org/wikipedia/commons/4/46/Grunge_texture.png');
            mask-size: cover;
            -webkit-mask-image: url('https://upload.wikimedia.org/wikipedia/commons/4/46/Grunge_texture.png');
            -webkit-mask-size: cover;
        }
        
        .zoom-in-cursor { cursor: zoom-in; }
        .zoom-out-cursor { cursor: zoom-out; }

        .hero-gradient {
            background: linear-gradient(to top, #f8fafc 15%, rgba(248, 250, 252, 0.7) 40%, transparent 100%);
        }

        /* Colorful Weather Icons */
        .icon-sun { color: #f59e0b; filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.4)); }
        .icon-cloud { color: #94a3b8; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .icon-rain { color: #3b82f6; filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3)); }
        .icon-snow { color: #bae6fd; filter: drop-shadow(0 0 5px rgba(186, 230, 253, 0.5)); }
        .icon-bolt { color: #eab308; }

        /* Airline Themes */
        .ticket-header { font-family: 'Helvetica Neue', Arial, sans-serif; letter-spacing: 1px; }
        
        /* Train Themes */
        .ticket-haruka { background: #ffffff; border: 1px solid #ddd; background-image: radial-gradient(#fce7f3 1px, transparent 1px); background-size: 10px 10px; }
        .ticket-shinkansen { background: #f0f9ff; border-bottom: 4px solid #0ea5e9; }
        .ticket-sightseeing { background: #fffbeb; border: 1px solid #fcd34d; border-bottom: 4px solid #b45309; }
        .ticket-cable { background: #f0fdf4; border: 1px solid #86efac; border-bottom: 4px solid #166534; }
        
        /* Vintage Spot Ticket */
        .ticket-vintage {
            background-color: #fdfbf7;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4b165' fill-opacity='0.05'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 .895 2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 .895 2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 .895 2 2 .895 2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 .895 2 2 .895 2 2 .895 2 2 2z' /%3E%3C/g%3E%3C/svg%3E");
            border: 1px solid #e2d9c8;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        
/* Font Hand override for titles */
        h1, h2, .hand-font {
            /* 強制使用手寫體，如果失敗則退回圓體 */
            font-family: 'ZCOOL KuaiLe', 'M PLUS Rounded 1c', sans-serif !important;
        }
        
        /* --- 圖示發光特效 (Icon Glow) --- */
.icon-glow {
    /* 使用 drop-shadow 讓光暈沿著圖示邊緣產生 */
    filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.2));
}

/* ★★★ 新增這行：Vue 載入前隱藏元素 (解決閃現問題) ★★★ */
        [v-cloak] { display: none !important; }
    </style>

</head>
<body class="bg-gray-200 h-[100dvh] w-full overflow-hidden flex justify-center font-sans">

<div id="app" v-cloak class="w-full max-w-lg h-full relative flex flex-col bg-bg shadow-2xl overflow-hidden sm:rounded-3xl sm:my-4 sm:h-[95vh] sm:border-8 sm:border-white">

<div v-if="showDeleteConfirm" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @click="showDeleteConfirm = false"></div>
        
        <div class="bg-white rounded-3xl p-6 shadow-2xl relative z-10 w-full max-w-[280px] text-center border border-slate-100 transform transition-all scale-100">
            <div class="w-14 h-14 rounded-full bg-red-50 text-red-500 flex items-center justify-center mx-auto mb-4 shadow-sm">
                <i class="fa-solid fa-trash-can text-2xl"></i>
            </div>
            <h3 class="font-bold text-lg text-slate-800 mb-2">確定要刪除嗎？</h3>
            <p class="text-xs text-slate-500 mb-6 leading-relaxed">此動作將永久移除這筆資料<br>且無法復原。</p>
            <div class="flex gap-3">
                <button @click="showDeleteConfirm = false" class="flex-1 py-3 rounded-2xl bg-slate-100 text-slate-500 font-bold text-xs hover:bg-slate-200 transition-colors">
                    再想想
                </button>
                <button @click="executeDelete" class="flex-1 py-3 rounded-2xl bg-red-500 text-white font-bold text-xs shadow-lg shadow-red-500/30 hover:bg-red-600 transition-colors">
                    確認刪除
                </button>
            </div>
        </div>
    </div>
    
    <!-- === Main Layout === -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- === Left Sidebar === -->
        <aside class="w-20 bg-sidebar flex flex-col items-center py-6 border-r border-slate-200 z-20 shrink-0 overflow-y-auto no-scrollbar shadow-sm">
            <div class="mb-4">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gold to-yellow-500 flex items-center justify-center text-white font-bold text-xs shadow-glow">
                    2025
                </div>
            </div>

             <div class="mb-4 w-full flex justify-center">
                <button @click="currentTab = 'packing'" 
                    class="w-10 h-10 rounded-xl bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-400 hover:text-gold hover:border-gold transition-colors relative group">
                    <i class="fa-solid fa-suitcase-rolling"></i>
                    <div class="absolute right-0 top-0 w-3 h-3 bg-red-400 rounded-full border-2 border-white" v-if="packingList.filter(i=>!i.checked).length > 0"></div>
                </button>
            </div>

            <!-- Day Tabs -->
            <div class="flex flex-col gap-6 w-full mb-6">
                <button v-for="(day, index) in tripData.days" :key="index"
                    @click="selectDay(index)"
                    class="relative w-full flex flex-col items-center group">
                    <div v-if="currentTab === 'itinerary' && selectedDayIndex === index" 
                         class="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-8 bg-gold rounded-r-full shadow-glow"></div>

                    <div class="transition-all duration-300 transform group-active:scale-95"
                         :class="(currentTab === 'itinerary' && selectedDayIndex === index) ? 'text-gold font-bold' : 'text-slate-400'">
                        <i :class="getDayIcon(index)" class="text-xl mb-1 block text-center"></i>
                        <span class="text-[9px] uppercase font-bold tracking-widest block text-center leading-none">Day {{ index + 1 }}</span>
                    </div>
                </button>
                <button @click="addDay" class="text-slate-300 hover:text-gold transition-colors">
                    <i class="fa-solid fa-circle-plus text-xl"></i>
                </button>
            </div>

            <!-- Bottom Tools -->
            <div class="mt-auto flex flex-col gap-4 pt-4 border-t border-slate-100 w-full items-center pb-6">
                <!-- AI Assistant Button -->
               <div class="mt-auto flex flex-col gap-2 pt-4 border-t border-slate-100 w-full items-center pb-6">
    
    <button @click="currentTab = 'ai_chat'" 
            class="flex flex-col items-center mb-2 group transition-all"
            :class="currentTab === 'ai_chat' ? 'text-gold' : 'text-slate-400'">
        <div class="w-8 h-8 flex items-center justify-center transition-all duration-300" 
             :class="currentTab === 'ai_chat' ? 'text-gold icon-glow scale-110' : 'bg-transparent text-slate-400 group-hover:text-slate-600 group-hover:scale-110'">
            <i class="fa-solid fa-user-tie text-2xl"></i>
        </div>
        <span class="text-[9px] font-bold block leading-tight text-center mt-0.5">管家<br>Butler</span>
    </button>

    <button @click="currentTab = 'info'" 
            class="flex flex-col items-center mb-2 group transition-all"
            :class="currentTab === 'info' ? 'text-gold' : 'text-slate-400'">
        <div class="w-8 h-8 flex items-center justify-center transition-all duration-300" 
             :class="currentTab === 'info' ? 'text-gold icon-glow scale-110' : 'bg-transparent text-slate-400 group-hover:text-slate-600 group-hover:scale-110'">
            <i class="fa-solid fa-circle-info text-2xl"></i>
        </div>
        <span class="text-[9px] font-bold block leading-tight text-center mt-0.5">資訊<br>Info</span>
    </button>

    <button @click="currentTab = 'subway'" 
            class="flex flex-col items-center mb-2 group transition-all"
            :class="currentTab === 'subway' ? 'text-gold' : 'text-slate-400'">
        <div class="w-8 h-8 flex items-center justify-center transition-all duration-300" 
             :class="currentTab === 'subway' ? 'text-gold icon-glow scale-110' : 'bg-transparent text-slate-400 group-hover:text-slate-600 group-hover:scale-110'">
            <i class="fa-solid fa-map text-2xl"></i>
        </div>
        <span class="text-[9px] font-bold block leading-tight text-center mt-0.5">地圖<br>Map</span>
    </button>

    <button @click="currentTab = 'tickets'" 
            class="flex flex-col items-center mb-2 group transition-all"
            :class="currentTab === 'tickets' ? 'text-gold' : 'text-slate-400'">
        <div class="w-8 h-8 flex items-center justify-center transition-all duration-300" 
             :class="currentTab === 'tickets' ? 'text-gold icon-glow scale-110' : 'bg-transparent text-slate-400 group-hover:text-slate-600 group-hover:scale-110'">
            <i class="fa-solid fa-ticket text-2xl"></i>
        </div>
        <span class="text-[9px] font-bold block leading-tight text-center mt-0.5">票券<br>Pass</span>
    </button>

    <button @click="currentTab = 'wallet'" 
            class="flex flex-col items-center mb-2 group transition-all"
            :class="currentTab === 'wallet' ? 'text-gold' : 'text-slate-400'">
        <div class="w-8 h-8 flex items-center justify-center transition-all duration-300" 
             :class="currentTab === 'wallet' ? 'text-gold icon-glow scale-110' : 'bg-transparent text-slate-400 group-hover:text-slate-600 group-hover:scale-110'">
            <i class="fa-solid fa-wallet text-2xl"></i>
        </div>
        <span class="text-[9px] font-bold block leading-tight text-center mt-0.5">錢包<br>Wallet</span>
    </button>

    <button @click="currentTab = 'language'" 
            class="flex flex-col items-center mb-2 group transition-all"
            :class="currentTab === 'language' ? 'text-gold' : 'text-slate-400'">
        <div class="w-8 h-8 flex items-center justify-center transition-all duration-300" 
             :class="currentTab === 'language' ? 'text-gold icon-glow scale-110' : 'bg-transparent text-slate-400 group-hover:text-slate-600 group-hover:scale-110'">
            <i class="fa-solid fa-language text-2xl"></i>
        </div>
        <span class="text-[9px] font-bold block leading-tight text-center mt-0.5">翻譯<br>JP</span>
    </button>

    <button @click="currentTab = 'memories'" 
            class="flex flex-col items-center mb-2 group transition-all"
            :class="currentTab === 'memories' ? 'text-gold' : 'text-slate-400'">
        <div class="w-8 h-8 flex items-center justify-center transition-all duration-300" 
             :class="currentTab === 'memories' ? 'text-gold icon-glow scale-110' : 'bg-transparent text-slate-400 group-hover:text-slate-600 group-hover:scale-110'">
            <i class="fa-solid fa-book-open text-2xl"></i>
        </div>
        <span class="text-[9px] font-bold block leading-tight text-center mt-0.5">回憶<br>Memo</span>
    </button>

    <button @click="currentTab = 'emergency'" 
            class="flex flex-col items-center mb-2 group transition-all mt-2"
            :class="currentTab === 'emergency' ? 'text-red-500' : 'text-red-400/70'">
        <div class="w-8 h-8 flex items-center justify-center transition-all duration-300" 
             :class="currentTab === 'emergency' ? 'text-red-500 icon-glow-red scale-110' : 'bg-transparent text-red-400 group-hover:text-red-600 group-hover:scale-110'">
            <i class="fa-solid fa-tower-broadcast text-2xl"></i>
        </div>
        <span class="text-[9px] font-bold block leading-tight text-center mt-0.5">求助<br>SOS</span>
    </button>

</div>
        </aside>

        <!-- === Right Content Area === -->
 
        <main class="flex-1 relative overflow-y-auto no-scrollbar bg-bg" id="mainContent" 
              @touchstart="handleTouchStart" 
              @touchmove="handleTouchMove" 
              @touchend="handleTouchEnd">

            <div id="pull-refresh-loader" class="w-full flex justify-center items-center overflow-hidden transition-all duration-300" style="height: 0px; opacity: 0;">
                <div class="bg-white p-2 rounded-full shadow-md text-gold">
                    <i class="fa-solid fa-rotate-right fa-spin text-xl"></i>
                </div>
            </div>
            
            <!-- ... (EMERGENCY and AI CHAT tabs remain unchanged) ... -->
            <!-- === TAB: EMERGENCY (SOS) === -->
            <div v-if="currentTab === 'emergency'" class="min-h-full bg-slate-900 text-white p-6 pb-24">
                <h2 class="text-xl font-bold text-red-500 mb-2 flex items-center gap-3">
                    <i class="fa-solid fa-kit-medical"></i> 緊急求助 SOS
                </h2>
                <div class="space-y-4 mt-6">
                    <div class="bg-slate-800 border border-slate-700 rounded-2xl p-5 flex items-center justify-between shadow-lg">
                        <div><h3 class="text-xl font-bold text-red-400 mb-1">警察局 Police</h3><p class="text-xs text-slate-400">110</p></div>
                        <a href="tel:110" class="bg-red-600 text-white px-6 py-3 rounded-full font-bold text-lg"><i class="fa-solid fa-phone"></i></a>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-2xl p-5 flex items-center justify-between shadow-lg">
                        <div><h3 class="text-xl font-bold text-red-400 mb-1">救護車 Ambulance</h3><p class="text-xs text-slate-400">119</p></div>
                        <a href="tel:119" class="bg-red-600 text-white px-6 py-3 rounded-full font-bold text-lg"><i class="fa-solid fa-phone"></i></a>
                    </div>
                    <div class="bg-slate-800 border border-blue-900/50 rounded-2xl p-5 shadow-lg relative overflow-hidden">
                        <div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold text-blue-400">駐大阪辦事處</h3><a href="tel:+81-6-6227-8623" class="bg-blue-600 w-12 h-12 rounded-full flex items-center justify-center"><i class="fa-solid fa-phone"></i></a></div>
                        <p class="text-xs text-slate-400"><i class="fa-solid fa-location-dot mr-1"></i> 大阪市北區中之島2-3-18</p>
                        <p class="text-xs text-slate-400"><i class="fa-solid fa-phone mr-1"></i> 急難: +81-90-8794-4568</p>
                    </div>
                </div>
            </div>

            <!-- === TAB: AI CHAT (New) === -->
            <div v-if="currentTab === 'ai_chat'" class="flex flex-col h-full bg-slate-50 relative">
                <!-- Header -->
                <div class="p-4 bg-white border-b border-slate-200 shadow-sm z-10 flex items-center gap-3">
                     <div class="w-10 h-10 rounded-full bg-slate-800 border-2 border-gold flex items-center justify-center text-gold text-lg">
                        <i class="fa-solid fa-user-tie"></i>
                     </div>
                     <div>
                        <h2 class="text-lg font-bold text-slate-800">關西旅遊管家</h2>
                        <p class="text-xs text-slate-500">您的專屬行程顧問 (Osaka & Kyoto)</p>
                     </div>
                </div>
                
                <!-- Chat Box -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50" id="aiChatBox">
                     <div v-for="(msg, i) in aiMessages" :key="i" class="flex gap-3" :class="msg.role==='user'?'flex-row-reverse':''">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 border border-slate-200 shadow-sm" :class="msg.role==='ai'?'bg-slate-800 text-gold':'bg-white text-slate-500'">
                            <i class="fa-solid" :class="msg.role==='ai'?'fa-user-tie':'fa-user'"></i>
                        </div>
                        <div class="p-3 rounded-2xl text-sm shadow-sm max-w-[80%] leading-relaxed" :class="msg.role==='user'?'bg-gold text-white rounded-tr-none':'bg-white text-slate-700 border border-slate-100 rounded-tl-none'">
                            {{ msg.text }}
                        </div>
                    </div>
                    
                    <!-- Thinking Indicator -->
                    <div v-if="isAiThinking" class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center shrink-0 text-gold"><i class="fa-solid fa-user-tie"></i></div>
                        <div class="bg-white p-3 rounded-2xl text-xs text-slate-400 shadow-sm rounded-tl-none border border-slate-100 flex items-center gap-2">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> 正在思考您的需求...
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 bg-white border-t border-slate-200">
                     <div class="flex gap-2 items-end">
                        <div class="flex-1 bg-slate-100 rounded-2xl flex items-center p-1 pr-2 border border-transparent focus-within:border-gold focus-within:bg-white transition-all">
                            <textarea v-model="aiInput" @keydown.enter.prevent="sendAIMessage" placeholder="請詢問行程、交通或美食建議..." class="w-full bg-transparent border-none focus:ring-0 resize-none text-sm p-3 max-h-24 outline-none placeholder-slate-400" rows="1"></textarea>
                            <button @click="sendAIMessage" class="w-8 h-8 rounded-full bg-gold text-white flex items-center justify-center shadow-sm hover:scale-105 transition-transform"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === TAB: TICKET COLLECTION === -->
            <div v-if="currentTab === 'tickets'" class="p-5 pb-24 bg-bg min-h-full">
                <!-- (Ticket Collection Content) -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800 border-l-4 border-gold pl-3">票券蒐集冊 Tickets</h2>
                    <div class="flex gap-2">
                        <!-- Add Button Dropdown -->
                        <div class="relative group">
                             <button class="bg-gold text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-glow flex items-center gap-1"><i class="fa-solid fa-plus"></i> 新增</button>
                             <div class="absolute right-0 top-full mt-2 w-32 bg-white rounded-xl shadow-xl border border-slate-100 hidden group-hover:block z-30 p-1">
                                 <button @click="openModal('ticket_flight')" class="w-full text-left px-3 py-2 text-xs hover:bg-slate-50 rounded-lg text-slate-700">機票 Flight</button>
                                 <button @click="openModal('ticket_train')" class="w-full text-left px-3 py-2 text-xs hover:bg-slate-50 rounded-lg text-slate-700">車票 Train</button>
                                 <button @click="openModal('ticket_spot')" class="w-full text-left px-3 py-2 text-xs hover:bg-slate-50 rounded-lg text-slate-700">門票 Spot</button>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-8">
                     <!-- FLIGHTS -->
                     <div v-if="groupedTickets.flights.length">
                        <div class="flex justify-between items-center mb-3 ml-1">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider"><i class="fa-solid fa-plane mr-2"></i>Flights</h3>
                            <button @click="toggleSort('ticket_flights', groupedTickets.flights, 'ticket-flights-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['ticket_flights'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['ticket_flights'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                            </button>
                        </div>
                        <div id="ticket-flights-list" class="space-y-4">
                            <div v-for="(ticket, idx) in groupedTickets.flights" :key="ticket.id" class="relative group" :class="isSorting.ticket_flights ? '' : 'cursor-pointer'" @click="!isSorting.ticket_flights && openModal('ticket_flight', ticket)">
                                <div v-if="isSorting.ticket_flights" class="absolute -top-3 -right-2 z-20 bg-white border border-slate-200 rounded-full p-1.5 shadow-md drag-handle text-slate-400 cursor-grab active:cursor-grabbing"><i class="fa-solid fa-bars text-sm"></i></div>
                                <div class="rounded-2xl shadow-xl overflow-hidden relative" :style="getAirlineStyle(ticket.airline, ticket.class).container">
                                     <div class="p-3 flex justify-between items-center relative z-10" :style="getAirlineStyle(ticket.airline, ticket.class).header">
                                         <div class="flex items-center gap-3">
                                             <img :src="getAirlineLogo(ticket.airline)" class="w-8 h-8 rounded-full bg-white object-contain p-0.5 shadow-sm">
                                             <span class="font-bold text-lg tracking-wider ticket-header uppercase" :style="{color: getAirlineStyle(ticket.airline, ticket.class).headerText}">
                                                 {{ ticket.airline }} <span class="text-sm font-normal opacity-80">{{ airlineData[ticket.airline]?.name }}</span>
                                             </span>
                                         </div>
                                         <span class="text-xs font-bold uppercase tracking-widest px-2" :style="{color: getAirlineStyle(ticket.airline, ticket.class).headerText}">{{ ticket.class }}</span>
                                     </div>
                                     <div class="p-4 relative z-10" :style="{color: getAirlineStyle(ticket.airline, ticket.class).text}">
                                         <div class="flex justify-between items-center mb-4"><div><div class="text-[10px] uppercase opacity-60 font-bold">Passenger</div><div class="font-bold text-sm">{{ ticket.passenger || 'MEMBERS' }}</div></div><div class="text-right"><div class="text-[10px] uppercase opacity-60 font-bold">Flight</div><div class="font-bold text-xl font-mono">{{ ticket.number }}</div></div></div>
                                         <div class="flex justify-between items-end mb-4"><div><div class="text-4xl font-mono font-bold leading-none">{{ ticket.depCode }}</div><div class="text-[10px] uppercase opacity-80 mt-1">{{ ticket.depCity }}</div></div><div class="flex flex-col items-center flex-1 px-4 pb-1"><svg class="w-6 h-6 mb-1 opacity-70 fill-current rotate-90" viewBox="0 0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg><div class="w-full border-b-2 border-dashed border-current opacity-30"></div><div class="text-[10px] font-mono mt-1 opacity-80">{{ ticket.date }}</div></div><div class="text-right"><div class="text-4xl font-mono font-bold leading-none">{{ ticket.arrCode }}</div><div class="text-[10px] uppercase opacity-80 mt-1">{{ ticket.arrCity }}</div></div></div>
                                         <div class="grid grid-cols-3 gap-2 border-t border-dashed border-current/20 pt-3"><div><div class="text-[9px] uppercase opacity-60 font-bold">Gate</div><div class="text-2xl font-bold font-mono">{{ ticket.gate || '--' }}</div></div><div class="text-center"><div class="text-[9px] uppercase opacity-60 font-bold">Boarding</div><div class="text-2xl font-bold font-mono">{{ ticket.depTime }}</div></div><div class="text-right"><div class="text-[9px] uppercase opacity-60 font-bold">Seat</div><div class="text-2xl font-bold font-mono">{{ ticket.seat || '--' }}</div></div></div>
                                     </div>
                                     <div class="bg-white p-2 relative z-10 border-t border-dashed border-slate-200"><img src="https://bwipjs-api.metafloor.com/?bcid=pdf417&text=BOARDINGPASS&height=8&scale=2" class="w-full h-8 opacity-60"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- TRAINS -->
                    <div v-if="groupedTickets.trains.length">
                        <div class="flex justify-between items-center mb-3 ml-1">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider"><i class="fa-solid fa-train mr-2"></i>Transport</h3>
                            <button @click="toggleSort('ticket_trains', groupedTickets.trains, 'ticket-trains-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['ticket_trains'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['ticket_trains'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                            </button>
                        </div>
                         <div id="ticket-trains-list" class="space-y-4">
                            <div v-for="(ticket, idx) in groupedTickets.trains" :key="ticket.id" class="group relative" :class="isSorting.ticket_trains ? '' : 'cursor-pointer'" @click="!isSorting.ticket_trains && openModal('ticket_train', ticket)">
                                <div v-if="isSorting.ticket_trains" class="absolute -top-3 -right-2 z-20 bg-white border border-slate-200 rounded-full p-1.5 shadow-md drag-handle text-slate-400 cursor-grab active:cursor-grabbing"><i class="fa-solid fa-bars text-sm"></i></div>
                                <div :class="getTrainClass(ticket.trainType)" class="rounded-xl shadow-md overflow-hidden text-slate-800 relative bg-white">
                                     <div class="p-3 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
                                         <div class="flex items-center gap-2"><i class="fa-solid text-slate-500" :class="ticket.trainType==='CableCar'?'fa-mountain-sun':(ticket.trainType==='Sightseeing'?'fa-camera-retro':'fa-train')"></i><span class="font-bold text-sm">{{ ticket.name }}</span></div>
                                         <span class="text-xs font-mono font-bold text-slate-500">{{ ticket.date }}</span>
                                     </div>
                                     <div class="p-4 flex justify-between items-center"><div><div class="text-2xl font-bold text-slate-800">{{ ticket.depStation }}</div><div class="text-lg font-mono text-slate-600 font-bold">{{ ticket.depTime }}</div></div><div class="text-slate-300 text-xl"><i class="fa-solid fa-arrow-right"></i></div><div class="text-right"><div class="text-2xl font-bold text-slate-800">{{ ticket.arrStation }}</div><div class="text-lg font-mono text-slate-600 font-bold">{{ ticket.arrTime }}</div></div></div>
                                     <div class="bg-slate-50 p-2 grid grid-cols-3 gap-2 text-center border-t border-dashed border-slate-200 text-xs"><div><span class="text-slate-400 block text-[9px]">TYPE</span><span class="font-bold">{{ ticket.trainType }}</span></div><div><span class="text-slate-400 block text-[9px]">CAR</span><span class="font-bold">{{ ticket.car }}</span></div><div><span class="text-slate-400 block text-[9px]">SEAT</span><span class="font-bold">{{ ticket.seat }}</span></div></div>
                                </div>
                            </div>
                         </div>
                    </div>
                    <!-- SPOTS -->
                    <div v-if="groupedTickets.spots.length">
                        <div class="flex justify-between items-center mb-3 ml-1">
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider"><i class="fa-solid fa-ticket mr-2"></i>Attractions</h3>
                            <button @click="toggleSort('ticket_spots', groupedTickets.spots, 'ticket-spots-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['ticket_spot'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['ticket_spot'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                            </button>
                        </div>
                        <div id="ticket-spots-list" class="space-y-4">
                            <div v-for="(ticket, idx) in groupedTickets.spots" :key="ticket.id" class="group relative" :class="isSorting.ticket_spots ? '' : 'cursor-pointer'" @click="!isSorting.ticket_spots && openModal('ticket_spot', ticket)">
                                <div v-if="isSorting.ticket_spots" class="absolute -top-3 -right-2 z-20 bg-white border border-slate-200 rounded-full p-1.5 shadow-md drag-handle text-slate-400 cursor-grab active:cursor-grabbing"><i class="fa-solid fa-bars text-sm"></i></div>
                                <div class="ticket-vintage rounded-xl flex overflow-hidden h-36 relative">
                                     <div class="w-32 relative border-r-2 border-dashed border-[#bfa588]">
                                         <img :src="ticket.image || 'https://image.pollinations.ai/prompt/vintage travel photo of ' + ticket.name" class="w-full h-full object-cover grayscale sepia-[.3] opacity-90">
                                         <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                         <div class="absolute bottom-2 w-full text-center text-[#fdfbf7] font-vintage font-bold text-xs tracking-widest uppercase">Admit One</div>
                                     </div>
                                     <div class="flex-1 p-4 flex flex-col justify-between relative">
                                         <div class="absolute top-2 right-2 text-[#bfa588] opacity-30 text-4xl font-bold rotate-12 border-4 border-[#bfa588] rounded-full w-16 h-16 flex items-center justify-center mask-image-grunge">★</div>
                                         <div><h3 class="font-bold text-xl text-slate-800 leading-tight mb-1 font-vintage uppercase tracking-wide">{{ ticket.name }}</h3><p class="text-xs text-slate-500 font-vintage"><i class="fa-regular fa-calendar mr-1"></i> {{ ticket.date }}</p></div>
                                         <div class="flex justify-between items-end border-t border-dashed border-[#d4b165] pt-2"><div class="text-[10px] text-slate-400 uppercase tracking-widest">No. {{ String(ticket.id).slice(-6) }}</div><span class="text-red-800 font-bold font-mono text-lg">{{ ticket.currency }} {{ ticket.price }}</span></div>
                                     </div>
                                     <div class="absolute top-[-8px] left-[7.8rem] w-4 h-4 bg-bg rounded-full shadow-inner z-10"></div><div class="absolute bottom-[-8px] left-[7.8rem] w-4 h-4 bg-bg rounded-full shadow-inner z-10"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === TAB: ITINERARY === -->
            <div v-if="currentTab === 'itinerary'" class="min-h-full pb-24">
                <div class="relative h-72 w-full">
                    <img :src="currentDayData.image || 'https://images.unsplash.com/photo-1536098561742-ca998e48cbcc?q=80&w=2036&auto=format&fit=crop'" class="w-full h-full object-cover">
                    <div class="absolute inset-0 hero-gradient"></div>
                    <div class="absolute bottom-6 left-6 right-6 z-10">
                        <div class="flex justify-between items-end mb-2">
                            <span class="bg-gold text-white px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-sm">{{ currentDayData.weekday }} · {{ currentDayData.date }}</span>
                            <!-- Sort Button for Itinerary (On Header) -->
                       </div>
                        <h1 class="text-3xl font-bold text-slate-800 leading-tight mb-2 drop-shadow-sm flex items-center">{{ currentDayData.title }}<button @click="editDayTitle" class="text-slate-400 text-sm ml-2 bg-white/50 w-6 h-6 rounded-full flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-pen"></i></button></h1>
                        <p class="text-slate-600 text-sm line-clamp-2 font-medium bg-white/60 backdrop-blur-md p-2 rounded-lg shadow-sm inline-block max-w-full border border-white">{{ currentDayData.desc }}</p>
                    </div>
                    <label class="absolute top-4 right-4 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center cursor-pointer hover:bg-gold transition-colors backdrop-blur-sm"><input type="file" class="hidden" accept="image/*" @change="(e) => handleImageUpload(e, 'day')"><i class="fa-solid fa-camera text-xs"></i></label>
                </div>

                <div class="px-5 mb-6 relative z-10 mt-0">
                    <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-2xl p-5 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fa-solid fa-location-arrow text-[10px] text-slate-400"></i>
                                    <span class="font-bold text-slate-700 text-sm">{{ getWeatherCityForDay(selectedDayIndex).name }}</span>
                                </div>
                                <div class="text-4xl font-mono font-bold text-slate-800">{{ weatherForecast5Days[0]?.temp || '--' }}°</div>
                                <div class="text-xs text-slate-400 mt-1">今日天氣 ({{ weatherForecast5Days[0]?.dateStr }})</div>
                            </div>
                            <div class="text-6xl"><i :class="[weatherForecast5Days[0]?.icon, weatherForecast5Days[0]?.colorClass]" class="weather-line-icon"></i></div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 pt-4 border-t border-blue-100/50">
                            <div v-for="(w, i) in weatherForecast5Days.slice(1)" :key="i" class="flex flex-col items-center">
                                <span class="text-[10px] text-slate-400 uppercase font-bold mb-1">{{ w.dateStr }}</span><i :class="[w.icon, w.colorClass]" class="mb-2 text-lg weather-line-icon"></i><span class="font-mono font-bold text-slate-700 text-xs">{{ w.temp }}°</span><div class="flex items-center gap-0.5 mt-1"><i class="fa-solid fa-droplet text-[8px] text-blue-300"></i><span class="text-[9px] text-blue-400 font-bold">{{ w.rain }}%</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="px-5 mb-6">
                    <div class="border-l-4 border-gold bg-gold-dim/30 p-4 rounded-r-xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 text-gold/20 text-6xl -mt-2 -mr-2 rotate-12"><i class="fa-solid fa-lightbulb"></i></div>
                        <h3 class="text-yellow-700 text-sm font-bold uppercase tracking-widest mb-1 flex items-center gap-2"><i class="fa-solid fa-lightbulb"></i> 旅遊小TIPS</h3>
                        <p class="text-sm text-slate-600 leading-relaxed relative z-10 pr-8">{{ currentDayData.tips || '點擊魔杖生成今日提示' }}</p>
                        <button @click="generateAITip" class="absolute bottom-2 right-2 text-gold hover:text-yellow-600 w-8 h-8 rounded-full bg-white/80 shadow-sm flex items-center justify-center transition-all active:scale-95"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                    </div>
                </div>

                <div class="px-5 mb-6">
                    <div class="bg-card rounded-2xl shadow-soft overflow-hidden border border-slate-100">
                        <div id="map-container" class="relative z-0"></div>
                        <div class="bg-white p-2 flex justify-between items-center text-xs text-slate-500 border-t border-slate-100"><span><i class="fa-solid fa-location-dot text-gold mr-1"></i> 今日行程地圖</span><button @click="locateMe" class="text-blue-500 hover:text-blue-700 font-bold"><i class="fa-solid fa-crosshairs"></i> 我的位置</button></div>
                    </div>
                </div>

                <div class="px-5 relative">
                    <div class="absolute left-[2.2rem] top-2 bottom-10 w-[2px] bg-slate-200"></div>
                    <!-- Sortable Container -->
                    <div id="itinerary-list">
                        <div v-for="(item, idx) in currentDayItinerary" :key="item.id" class="relative mb-8 group" :class="isSorting.itinerary ? 'cursor-grab' : ''">
                            <div class="absolute left-[0.35rem] top-1 z-10 bg-bg p-1"><div class="w-3 h-3 rounded-full border-2 border-gold bg-white shadow-glow" :class="item.checkedIn ? 'bg-gold' : ''"></div></div>
                            <div class="pl-10 relative">
                                <!-- Header -->
                                <div class="flex justify-between items-start mb-1">
                                    <div class="font-mono text-gold text-sm font-bold tracking-wide pt-1">{{ item.time }}</div>
                                <button @click="toggleSort('itinerary', currentDayItinerary, 'itinerary-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['itinerary'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['itinerary'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>

</button> 

                                </div>
                                
                                <!-- Transport Route ABOVE the card -->
                                <div v-if="item.nextTransport && item.nextTransport.mode" class="mb-3">
                                    <div v-if="item.nextTransport.isRichText" 
                                         v-html="item.nextTransport.mode" 
                                         class="text-[11px] text-slate-600 bg-white/60 p-2.5 rounded-lg border border-slate-200/60 leading-relaxed break-all [&_*]:!text-[11px] [&_*]:!font-medium [&_*]:!text-slate-600 [&_*]:!bg-transparent [&_img]:hidden">
                                    </div>

                                    <div v-else class="flex items-center">
                                        <div class="relative flex flex-col items-center mr-3">
                                            <div class="w-[2px] h-4 bg-slate-200 absolute -top-4"></div>
                                            <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                                            <div class="w-[2px] h-4 bg-slate-200"></div>
                                        </div>
                                        <span class="px-3 py-1.5 rounded-lg text-xs border backdrop-blur-sm shadow-sm" 
                                              :class="{'font-bold': item.nextTransport.isBold, 'italic': item.nextTransport.isItalic}"
                                              :style="{ backgroundColor: item.nextTransport.useFrame ? getTransportColor(item.nextTransport.style?.color).bg : 'transparent', borderColor: item.nextTransport.useFrame ? getTransportColor(item.nextTransport.style?.color).border : 'transparent', color: getTransportColor(item.nextTransport.style?.color).textDark }">
                                            <i class="fa-solid fa-location-arrow mr-1 opacity-70"></i> {{ item.nextTransport.mode }}
                                        </span>
                                    </div>
                                </div>                                
                                <div @click="!isSorting.itinerary && openModal('activity', item)" class="bg-card rounded-xl border border-slate-100 hover:border-gold/50 transition-all shadow-soft relative overflow-hidden active:scale-98 flex flex-col group" :class="isSorting.itinerary ? '' : 'cursor-pointer'">
                                    
                                    <!-- Drag Handle (Moved Here) -->
                                    <div v-if="isSorting.itinerary" class="drag-handle absolute right-3 top-1/2 -translate-y-1/2 z-30 bg-white/90 backdrop-blur-sm border border-slate-200 rounded-full w-10 h-10 flex items-center justify-center shadow-lg text-slate-400 cursor-grab active:cursor-grabbing hover:scale-110 transition-transform">
                                        <i class="fa-solid fa-bars text-lg"></i>
                                    </div>

                                    <div v-if="item.image" class="w-full h-40 relative bg-slate-100"><img :src="item.image" class="absolute inset-0 w-full h-full object-cover"></div>
                                    <div class="p-4 relative z-10 flex-1">
                                        <h3 class="text-xl font-bold text-slate-800 mb-2 leading-tight">{{ item.title }}</h3>
                                        <div class="space-y-2 mb-3">
                                             <div v-if="item.businessHours" class="text-xs text-slate-600 flex items-center gap-2"><i class="fa-regular fa-clock text-slate-400 w-4 text-center"></i><span>{{ item.businessHours }}</span></div>
                                             <div v-if="item.visitDate" class="text-xs text-slate-600 flex items-center gap-2"><i class="fa-regular fa-calendar text-slate-400 w-4 text-center"></i><span>{{ item.visitDate }}</span></div>
                                             <div v-if="item.note" class="text-xs text-slate-600 flex items-start gap-2"><i class="fa-regular fa-file-lines text-slate-400 w-4 text-center mt-0.5"></i><span class="line-clamp-2" v-html="item.note"></span></div>
                                        </div>
                                        <div class="flex flex-wrap gap-2 mb-3">
                                            <span v-if="item.city" class="px-2 py-1 rounded bg-blue-50 text-blue-600 text-[10px] font-bold">{{ item.city }}</span>
                                            <span v-if="item.type" class="px-2 py-1 rounded text-[10px] font-bold" :style="{backgroundColor: getTypeColor(item.type)+'20', color: getTypeColor(item.type)}">{{ item.type }}</span>
                                        </div>
                                        <div class="pt-3 border-t border-slate-50 flex justify-end" v-if="!isSorting.itinerary">
                                             <button @click.stop="openCheckInModal(item)" class="flex items-center gap-2 text-xs font-bold px-4 py-2 rounded-full border transition-colors shadow-sm" :class="item.checkedIn ? 'bg-gold text-white border-gold' : 'bg-white text-slate-500 border-slate-200 hover:text-gold hover:border-gold'">
                                                 <i class="fa-solid fa-camera"></i><span>{{ item.checkedIn ? '已打卡' : '打卡' }}</span>
                                             </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-8" v-if="!isSorting.itinerary"><button @click="openModal('activity')" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 hover:text-gold hover:border-gold transition-colors flex items-center justify-center gap-2 bg-white text-sm"><i class="fa-solid fa-plus"></i> 新增行程</button></div>
                </div>
            </div>

            <!-- === TAB: INFO === -->
            <div v-if="currentTab === 'info'" class="p-5 pb-24 bg-bg">
                <!-- ... (Info Content Unchanged) ... -->
                <h2 class="text-xl font-serif font-bold text-slate-800 mb-4 flex items-center">
                    <i class="fa-solid fa-circle-info text-gold mr-3"></i> 旅遊資訊 (Travel Info)</h2>
                </h2>

                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 mb-8">
    
                    <div class="flex items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                           <i class="fa-solid fa-qrcode text-xl" style="color: #a85d5d;"></i>
                           Visit Japan Web
                        </h3>
                    </div>

                    <label class="block w-full aspect-[4/3] rounded-[2rem] border-3 border-dashed border-slate-200 bg-[#fafaf9] flex flex-col items-center justify-center cursor-pointer hover:border-[#a85d5d]/30 hover:bg-[#fbeaea]/20 transition-all relative overflow-hidden group">
                        <input type="file" class="hidden" accept="image/*" @change="(e) => handleImageUpload(e, 'vjw')">
        
                        <div v-if="!tripData.vjwImage" class="flex flex-col items-center text-slate-400 group-hover:text-[#a85d5d] transition-colors">
                            <i class="fa-solid fa-plus text-4xl mb-3 text-slate-300 group-hover:text-[#a85d5d]/50 transition-colors"></i>
                            <span class="font-bold text-lg text-slate-500 group-hover:text-[#a85d5d] transition-colors">點擊上傳截圖</span>
                            <span class="text-xs mt-1 text-slate-400 font-medium">(存於本機)</span>
                        </div>
        
                        <img v-else :src="tripData.vjwImage" class="w-full h-full object-contain p-2">
        
                        <button v-if="tripData.vjwImage" @click.stop="tripData.vjwImage = null" class="absolute top-4 right-4 w-8 h-8 bg-black/60 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm hover:bg-black/80">
                            <i class="fa-solid fa-xmark text-sm"></i>
                        </button>
                    </label>

                    <a href="https://www.vjw.digital.go.jp/" target="_blank" class="block w-full py-2.5 rounded-xl text-center font-bold text-sm mt-4 transition-colors hover:brightness-95" style="background-color: #fbeaea; color: #a85d5d;">
                        開啟 VJW 官網
                    </a>
                </div>
                
                <div class="flex justify-between items-center mb-6 pl-2 border-l-4 border-gold">
                    <h2 class="text-xl font-bold text-slate-800">航班資訊 (Flight Info)</h2>
                    <button @click="toggleSort('flights', flights, 'flights-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['flights'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['flights'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                    </button>
                </div>
                <div id="flights-list" class="space-y-6 mb-10">
                    <div v-for="(flight, idx) in flights" :key="flight.id" class="relative group" :class="isSorting.flights ? '' : 'cursor-pointer'" @click="!isSorting.flights && openModal('flight', flight)">
                        <div v-if="isSorting.flights" class="absolute -top-3 -right-2 z-20 bg-white border border-slate-200 rounded-full p-1.5 shadow-md drag-handle text-slate-400 cursor-grab active:cursor-grabbing"><i class="fa-solid fa-bars text-sm"></i></div>
                        <!-- FLIGHT TICKET STYLE -->
                        <div class="rounded-2xl overflow-hidden relative shadow-lg filter" :style="getAirlineStyle(flight.airline, flight.class).container">
<div class="p-3 flex justify-between items-start relative z-10" :style="getAirlineStyle(flight.airline, flight.class).header">
                             <div class="flex items-center gap-3">
                                 <img :src="getAirlineLogo(flight.airline)" class="w-10 h-10 rounded-full bg-white object-contain p-1 shadow-sm">
                                 
                                 <div class="flex flex-col items-start leading-none">
                                     <span class="font-bold text-lg tracking-wider ticket-header uppercase mb-0.5" 
                                           :style="{color: getAirlineStyle(flight.airline, flight.class).headerText}">
                                         {{ flight.airline }}
                                     </span>
                                     <span class="text-[10px] font-bold opacity-80" 
                                           :style="{color: getAirlineStyle(flight.airline, flight.class).headerText}">
                                         {{ airlineData[flight.airline]?.name }}
                                     </span>
                                 </div>
                             </div>
                             
                             <span class="text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded bg-black/5" 
                                   :style="{color: getAirlineStyle(flight.airline, flight.class).headerText}">
                                 {{ flight.class }}
                             </span>
                        </div>
                                <div class="p-4 relative z-10" :style="{color: getAirlineStyle(flight.airline, flight.class).text}">
                                 <div class="flex justify-between items-center mb-4"><div><div class="text-[10px] uppercase opacity-60 font-bold">Passenger</div><div class="font-bold text-sm">{{ flight.passenger || 'MEMBERS' }}</div></div><div class="text-right"><div class="text-[10px] uppercase opacity-60 font-bold">Flight</div><div class="font-bold text-xl font-mono">{{ flight.number }}</div></div></div>
                                 <div class="flex justify-between items-end mb-4"><div><div class="text-4xl font-mono font-bold leading-none">{{ flight.depCode }}</div><div class="text-[10px] uppercase opacity-80 mt-1">{{ flight.depCity }}</div></div><div class="flex flex-col items-center flex-1 px-4 pb-1"><svg class="w-6 h-6 mb-1 opacity-70 fill-current rotate-90" viewBox="0 0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg><div class="w-full border-b-2 border-dashed border-current opacity-30"></div><div class="text-[10px] font-mono mt-1 opacity-80">{{ flight.date }}</div></div><div class="text-right"><div class="text-4xl font-mono font-bold leading-none">{{ flight.arrCode }}</div><div class="text-[10px] uppercase opacity-80 mt-1">{{ flight.arrCity }}</div></div></div>
                                 <div class="grid grid-cols-3 gap-2 border-t border-dashed border-current/20 pt-3"><div><div class="text-[9px] uppercase opacity-60 font-bold">Gate</div><div class="text-2xl font-bold font-mono">{{ flight.gate || '--' }}</div></div><div class="text-center"><div class="text-[9px] uppercase opacity-60 font-bold">Boarding</div><div class="text-2xl font-bold font-mono">{{ flight.depTime }}</div></div><div class="text-right"><div class="text-[9px] uppercase opacity-60 font-bold">Seat</div><div class="text-2xl font-bold font-mono">{{ flight.seat || '--' }}</div></div></div>
                             </div>
                             <div class="bg-white p-2 relative z-10 border-t border-dashed border-slate-200"><img src="https://bwipjs-api.metafloor.com/?bcid=pdf417&text=BOARDINGPASS&height=8&scale=2" class="w-full h-8 opacity-60"></div>
                        </div>
                    </div>
                    <button @click="openModal('flight')" class="w-full py-3 rounded-xl border border-dashed border-slate-300 text-slate-400 text-sm hover:border-gold hover:text-gold transition-colors bg-white text-sm">+ 新增航班</button>
                </div>
                 
                 <div class="flex justify-between items-center mb-4 pl-2 border-l-4 border-gold">
                     <h3 class="text-xl font-bold text-slate-700">交通資訊 (Transport Info)</h3>
                     <button @click="toggleSort('trains', trainTickets, 'trains-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['trains'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['trains'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                     </button>
                 </div>
                 <div id="trains-list" class="space-y-4 mb-10">
                     <div v-for="(train, idx) in trainTickets" :key="train.id" class="flex gap-2 items-center group relative">
                         <div v-if="isSorting.trains" class="absolute -top-3 -right-2 z-20 bg-white border border-slate-200 rounded-full p-1.5 shadow-md drag-handle text-slate-400 cursor-grab active:cursor-grabbing"><i class="fa-solid fa-bars text-sm"></i></div>
                         <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm relative group cursor-pointer flex-1" @click="!isSorting.trains && openModal('trainInfo', train)">
                             <button v-if="!isSorting.trains" @click.stop="deleteItem('trainInfo', train.id)" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full opacity-0 group-hover:opacity-100 text-xs"><i class="fa-solid fa-xmark"></i></button>
                             <div class="flex justify-between items-center mb-2"><div class="flex items-center gap-2"><i class="fa-solid text-slate-500" :class="train.trainType==='CableCar'?'fa-mountain-sun':(train.trainType==='Sightseeing'?'fa-camera-retro':'fa-train')"></i><span class="font-bold">{{ train.name }}</span></div><span class="text-xs font-mono bg-slate-100 px-2 py-1 rounded">{{ train.date }}</span></div>
                             <div class="flex justify-between text-sm"><span>{{ train.depTime }} {{ train.depStation }}</span><i class="fa-solid fa-arrow-right text-slate-300"></i><span>{{ train.arrTime }} {{ train.arrStation }}</span></div>
                             <div class="mt-2 text-xs text-slate-500 grid grid-cols-3 gap-2"><span>No. {{ train.number }}</span><span>Car {{ train.car }}</span><span>Seat {{ train.seat }}</span></div>
                         </div>
                     </div>
                     <button @click="openModal('trainInfo')" class="w-full py-3 rounded-xl border border-dashed border-slate-300 text-slate-400 text-sm hover:border-gold hover:text-gold transition-colors bg-white text-sm">+ 新增交通資訊</button>
                </div>
                 
                 <div class="flex justify-between items-center mb-4 pl-2 border-l-4 border-gold">
                     <h3 class="text-xl font-bold text-slate-700">飯店資訊 (Hotel Info)</h3>
                     <button @click="toggleSort('hotels', hotels, 'hotels-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['hotels'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['hotels'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                     </button>
                 </div>
                <div id="hotels-list" class="space-y-4">
                    <div v-for="(hotel, idx) in hotels" :key="idx" class="flex gap-2 relative group">
                        <div v-if="isSorting.hotels" class="absolute -top-3 -right-2 z-20 bg-white border border-slate-200 rounded-full p-1.5 shadow-md drag-handle text-slate-400 cursor-grab active:cursor-grabbing"><i class="fa-solid fa-bars text-sm"></i></div>
                        <div class="bg-white rounded-xl overflow-hidden border border-slate-100 flex relative group shadow-soft cursor-pointer flex-1" @click="!isSorting.hotels && openModal('hotel', hotel)">
                            <div class="w-24 bg-slate-200 relative"><img :src="hotel.image || 'https://images.unsplash.com/photo-1566073771259-6a8506099945?q=80&w=2070&auto=format&fit=crop'" class="absolute inset-0 w-full h-full object-cover"></div>
                            <div class="p-3 flex-1"><h4 class="font-bold text-slate-800 text-sm mb-1">{{ hotel.name }}</h4><p class="text-[10px] text-slate-500 mb-1"><i class="fa-solid fa-location-dot w-3 text-center"></i> {{ hotel.address }}</p><div class="flex gap-2 mb-2"><span class="bg-slate-50 px-2 py-1 rounded text-[10px] text-gold font-mono border border-slate-200 font-bold">In: {{ hotel.checkIn }}</span><span class="bg-slate-50 px-2 py-1 rounded text-[10px] text-gold font-mono border border-slate-200 font-bold">Out: {{ hotel.checkOut }}</span></div><p v-if="hotel.notes" class="text-[10px] text-slate-400 italic bg-slate-50 p-1 rounded border border-slate-100">{{ hotel.notes }}</p></div><button v-if="!isSorting.hotels" @click.stop="deleteItem('hotel', hotel.id)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>
                    <button @click="openModal('hotel')" class="w-full py-3 rounded-xl border border-dashed border-slate-300 text-slate-400 text-sm hover:border-gold hover:text-gold transition-colors bg-white text-sm">+ 新增住宿</button>
                </div>
            </div>

            <!-- ... (Wallet, Ticket Collection, etc. remain unchanged except removing sort arrows) ... -->
            
            <!-- === TAB: WALLET === -->
             <div v-if="currentTab === 'wallet'" class="p-5 pb-24 bg-bg min-h-full">
                 <h2 class="text-xl font-bold text-slate-800 mb-6 pl-2 border-l-4 border-gold">錢包 Wallet</h2>
                 <div class="bg-white rounded-2xl p-4 shadow-soft mb-6 border border-slate-100 relative">
                    <div class="flex justify-between items-center mb-3"><h3 class="text-gold font-bold text-xs uppercase tracking-wider"><i class="fa-solid fa-calculator"></i> 即時匯率換算</h3><button @click="fetchRates" class="text-slate-400 hover:text-gold text-xs"><i class="fa-solid fa-rotate-right"></i> 重新整理</button></div>
                    <div class="flex flex-col gap-3 mb-3">
                         <div class="relative"><input v-model="currencySearch" @focus="showCurrencyList=true" placeholder="搜尋幣別 (e.g. JPY, 日幣)" class="input-light w-full p-2 pl-3 rounded-lg text-xs font-bold uppercase"><div v-if="showCurrencyList" class="absolute top-full left-0 w-full max-h-40 overflow-y-auto bg-white border border-slate-200 rounded-lg shadow-lg z-50"><div v-for="c in filteredCurrencies" :key="c.code" @click="selectCurrency(c.code)" class="p-2 text-xs hover:bg-slate-50 cursor-pointer flex justify-between"><span class="font-bold">{{ c.code }}</span><span class="text-slate-500">{{ c.name }}</span></div></div></div>
                         <div class="text-[10px] text-slate-400">目前匯率: 1 {{ calcCurrency }} ≈ {{ currencyRates[calcCurrency]?.toFixed(3) || '--' }} TWD</div>
                    </div>
                    <div class="flex items-center gap-3"><div class="flex-1 relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 font-bold">{{ calcCurrency }}</span><input type="number" v-model="calcAmount" class="w-full bg-slate-50 border border-slate-200 rounded-lg py-2 pl-12 pr-2 text-right font-mono text-slate-800 font-bold focus:outline-none focus:border-gold"></div><i class="fa-solid fa-arrow-right-long text-slate-300"></i><div class="flex-1 relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 font-bold">TWD</span><div class="w-full bg-slate-100 border border-slate-200 rounded-lg py-2 pl-12 pr-2 text-right font-mono text-slate-800 font-bold">{{ Math.round(calcAmount * (currencyRates[calcCurrency] || 0)).toLocaleString() }}</div></div></div>
                </div>
                <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-6 text-white shadow-xl mb-8 relative overflow-hidden">
                    <div class="relative z-10"><h2 class="text-sm font-bold opacity-80 uppercase tracking-widest mb-1 text-gold">Total Trip Cost</h2><div class="text-4xl font-mono font-bold mb-4">NT$ {{ totalExpenseTWD.toLocaleString() }}</div><div class="text-[10px] opacity-60">* 已自動將所有外幣消費轉為台幣計算</div></div><div class="absolute -right-5 -bottom-10 text-9xl text-white/5"><i class="fa-solid fa-coins"></i></div>
                </div>
                
                <!-- Member Breakdown (Bank Book Style) -->
                <div class="bg-white rounded-2xl border border-slate-100 overflow-hidden mb-6 shadow-soft">
                    <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="text-slate-600 font-bold text-sm uppercase tracking-wider">分帳帳本 (Member Account)</h3>
                        <span class="text-[10px] text-slate-400 bg-white px-2 py-1 rounded-full border border-slate-200">
                            <i class="fa-solid fa-circle-info mr-1"></i>實際支出
                        </span>
                    </div>
                    
                    <div class="divide-y divide-slate-100">
                        <div v-for="m in members" :key="m" class="group">
                            <!-- Header -->
                            <div @click="toggleMemberDetail(m)" class="flex justify-between items-center p-4 cursor-pointer hover:bg-slate-50 transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500 shadow-sm ring-2 ring-white">
                                        {{ m[0] }}
                                    </div>
                                    <div>
                                        <span class="text-sm font-bold text-slate-700 block">{{ m }}</span>
                                        <div class="flex gap-2 text-[10px] font-medium">
                                            <span class="text-slate-400">個人支出: NT$ {{ Math.round(Math.abs(getMemberTotalConsumption(m))).toLocaleString() }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="font-mono font-bold text-base text-slate-600">
                                        -{{ Math.round(Math.abs(getMemberTotalConsumption(m))).toLocaleString() }}
                                    </span>
                                    <i class="fa-solid fa-chevron-down text-xs text-slate-300 transition-transform duration-300" :class="expandedMember === m ? 'rotate-180' : ''"></i>
                                </div>
                            </div>

                            <!-- Expanded Detail -->
                            <div v-if="expandedMember === m" class="bg-slate-50/80 p-3 space-y-4 animate-fade-in border-t border-slate-100 shadow-inner">
                                
                                <!-- 1. Settlement Summary (Top - Fixed) -->
                                <div class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-16 h-16 bg-blue-50/50 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                                    <div class="relative z-10">
                                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center">
                                            <i class="fa-solid fa-scale-balanced mr-2 text-gold"></i>應收/應付總計 (Net Settlement)
                                        </h4>
                                        <div class="space-y-2">
                                            <div v-for="st in getSettlementStats(m)" class="flex justify-between items-center text-xs p-2.5 rounded-lg bg-slate-50 border border-slate-100">
                                                <div class="flex items-center gap-2 font-bold text-slate-600">
                                                    <span class="w-1.5 h-1.5 rounded-full" :class="st.amount > 0 ? 'bg-green-500' : 'bg-red-500'"></span>
                                                    {{ st.amount > 0 ? '向' : '付給' }} 
                                                    <span class="bg-slate-200 px-1.5 py-0.5 rounded text-[10px]">{{ st.name }}</span>
                                                    {{ st.amount > 0 ? '收款' : '' }}
                                                </div>
                                                <span class="font-mono font-bold text-sm" :class="st.amount > 0 ? 'text-green-600' : 'text-red-500'">
                                                    {{ st.amount > 0 ? '+' : '' }}{{ Math.round(st.amount).toLocaleString() }}
                                                </span>
                                            </div>
                                            <div v-if="getSettlementStats(m).length === 0" class="text-center text-xs text-slate-400 py-2 italic">
                                                <i class="fa-solid fa-check-circle mr-1"></i>目前無欠款紀錄
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. Transaction History (Bank Book Style) -->
                                <div>
                                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 pl-2">帳戶明細 (Transactions)</h4>
                                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                                        <div v-for="(tx, idx) in getMemberTransactions(m)" :key="idx" class="p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50/50">
                                            
                                            <!-- Title Row -->
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex gap-3 items-center">
                                                    <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center flex-shrink-0 text-slate-500 text-xs">
                                                        <i :class="expenseTypes.find(t=>t.value===tx.category)?.icon || 'fa-solid fa-receipt'"></i>
                                                    </div>
                                                    <div>
                                                        <div class="font-bold text-slate-700 text-xs">{{ tx.item }}</div>
                                                        <div class="text-[9px] text-slate-400 font-mono">{{ tx.date.slice(5) }} • {{ tx.paidBy }}先付</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Lines: Consumption & Settlement -->
                                            <div class="pl-11 space-y-1.5">
                                                
                                                <!-- Line 1: My Consumption (Always Negative) -->
                                                <div v-if="tx.myConsumption !== 0" class="flex justify-between items-center text-[10px]">
                                                    <span class="text-slate-500 font-medium">
                                                        <i class="fa-solid fa-user-tag text-[9px] w-4 text-center"></i>個人消費 (Expense)
                                                    </span>
                                                    <span class="font-mono font-bold text-red-400">
                                                        {{ Math.round(tx.myConsumption).toLocaleString() }}
                                                    </span>
                                                </div>

                                                <!-- Line 2: Settlement Impact (Receivable + / Payable -) -->
                                                <div v-if="tx.settlementAmount !== 0" class="flex justify-between items-center text-[10px]">
                                                    <span class="font-medium" :class="tx.settlementAmount > 0 ? 'text-green-600' : 'text-red-500'">
                                                        <i class="fa-solid text-[9px] w-4 text-center" :class="tx.settlementAmount > 0 ? 'fa-hand-holding-dollar' : 'fa-money-bill-transfer'"></i>
                                                        {{ tx.settlementAmount > 0 ? '代墊應收 (Get)' : '應付他人 (Pay)' }}
                                                    </span>
                                                    <span class="font-mono font-bold" :class="tx.settlementAmount > 0 ? 'text-green-600' : 'text-red-500'">
                                                        {{ tx.settlementAmount > 0 ? '+' : '' }}{{ Math.round(tx.settlementAmount).toLocaleString() }}
                                                    </span>
                                                </div>
                                            </div>

                                        </div>
                                        <div v-if="getMemberTransactions(m).length === 0" class="text-center text-slate-400 text-xs py-4">無相關明細</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-slate-800">消費紀錄</h3><button @click="openModal('expense')" class="bg-gold text-white px-3 py-1 rounded-full text-xs font-bold hover:bg-yellow-600 transition-colors shadow-glow">+ 記帳</button></div>
                 
                 <!-- Updated Expense List -->
                <div class="space-y-3 pb-24">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white border border-slate-100 p-3 rounded-xl flex justify-between items-center group relative shadow-sm">
                        <div class="flex items-center gap-3">
                            <!-- Category Icon -->
                            <div class="w-10 h-10 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400">
                                <i :class="expenseTypes.find(t=>t.value===exp.category)?.icon || 'fa-solid fa-receipt'"></i>
                            </div>
                            <div>
                                <div class="text-slate-800 font-bold text-sm">{{ exp.item }} <span class="text-[10px] text-slate-400 font-normal ml-1">{{ exp.date }}</span></div>
                                <div class="text-xs text-slate-500 flex items-center gap-1">
                                    <span class="font-bold text-slate-600">{{ exp.payer }}</span>
                                    <span>paid</span>
                                    <i v-if="exp.payment==='card'" class="fa-regular fa-credit-card ml-1 text-[10px]"></i>
                                    <i v-else class="fa-solid fa-coins ml-1 text-[10px]"></i>
                                </div>
                                <!-- Split Info -->
                                <div class="text-[10px] text-blue-400 mt-0.5" v-if="exp.splitMode === 'self'">(個人自付)</div>
                                <div class="text-[10px] text-orange-400 mt-0.5" v-else-if="exp.splitMode === 'advance'">(代墊給 {{ exp.advanceSplits ? Object.keys(exp.advanceSplits).join(', ') : exp.beneficiary }})</div>
                                <div class="text-[10px] text-slate-300 mt-0.5" v-else>(共同分擔)</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-slate-800 font-mono font-bold">{{ exp.currency }} {{ exp.amount.toLocaleString() }}</div>
                            <div class="text-[10px] text-slate-400">≈ NT$ {{ Math.round(exp.amount * (currencyRates[exp.currency] || 0)).toLocaleString() }}</div>
                        </div>
                        <button @click.stop="deleteItem('expense', exp.id)" class="absolute right-0 top-0 h-full w-12 bg-red-100 text-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-r-xl"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>
                </div>
             </div>

            <!-- === TAB: LANGUAGE (Translation) === -->
            <div v-if="currentTab === 'language'" class="p-5 pb-24 bg-bg min-h-full">
                <div class="flex justify-between items-center mb-6 pl-2 border-l-4 border-gold">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 leading-tight">旅行常用翻譯</h2>
                        <p class="text-lxl font-bold text-slate-800 leading-tight">Commonly used translations</p>
                    </div>
                    <button @click="openModal('phrase')" class="bg-gold text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-yellow-600 transition-colors shadow-glow whitespace-nowrap shrink-0 flex items-center gap-1">
                        <i class="fa-solid fa-plus"></i> 新增卡片
                    </button>
                </div>
                
                <div class="grid grid-cols-1 gap-4">
                    <div v-for="(phrase, idx) in jpPhrases" :key="phrase.id || idx" 
                         class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center text-center cursor-pointer hover:border-gold hover:shadow-md transition-all active:scale-[0.98] group relative overflow-hidden">
                        
                        <div @click="focusedPhrase = phrase" class="w-full h-full absolute inset-0 z-0"></div>

                        <div class="absolute top-0 left-0 w-1 h-full bg-slate-100 group-hover:bg-gold transition-colors"></div>
                        
                        <button @click.stop="deleteItem('phrase', phrase.id)" class="absolute top-2 right-2 w-8 h-8 text-slate-200 hover:text-red-500 flex items-center justify-center transition-colors z-20 hover:bg-red-50 rounded-full">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>

                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 bg-slate-50 px-2 py-1 rounded-full relative z-10">{{ phrase.cat }}</span>
                        <h3 class="text-3xl font-bold text-slate-800 mb-2 relative z-10">{{ phrase.jp }}</h3>
                        <p class="text-sm text-slate-600 font-bold mb-1 relative z-10 w-full truncate px-4">{{ phrase.cn }}</p>
                        <p class="text-xs text-slate-400 font-mono relative z-10 w-full truncate px-4">{{ phrase.romaji }}</p>
                    </div>
                </div>
            </div>
            
            <!-- === TAB: MEMORIES === -->
            <div v-if="currentTab === 'memories'" class="p-5 pb-24 bg-bg min-h-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800 border-l-4 border-gold pl-3">旅行回憶 Memories</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-slate-400">{{ memories.length }} 個精彩時刻</span>
                        <button @click="toggleSort('memories', memories, 'memories-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['memories'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['memories'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                        </button>
                    </div>
                </div>
                <div v-if="memories.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-300">
                    <i class="fa-solid fa-camera-retro text-4xl mb-3"></i>
                    <p>還沒有打卡紀錄哦</p>
                </div>
                <div id="memories-list" class="grid grid-cols-2 gap-4">
                    <div v-for="(mem, idx) in memories" :key="mem.id" class="break-inside-avoid mb-4 relative group" :class="isSorting.memories ? '' : 'cursor-pointer'" @click="!isSorting.memories && viewMemory(mem)">
                        <div v-if="isSorting.memories" class="absolute -top-3 -right-2 z-20 bg-white border border-slate-200 rounded-full p-1.5 shadow-md drag-handle text-slate-400 cursor-grab active:cursor-grabbing"><i class="fa-solid fa-bars text-sm"></i></div>
                        <div class="relative bg-white p-3 pb-12 shadow-lg transition-transform duration-300 hover:scale-105 hover:z-10 group" :style="getPolaroidStyle(mem.id)">
                            <!-- Tape Effect -->
                            <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 bg-red-400/80 rotate-1 shadow-sm z-20 mask-tape"></div>
                            
                            <!-- Sticker (Generated) -->
                            <div class="absolute -top-2 -right-2 text-4xl filter drop-shadow-md z-20 transform transition-transform group-hover:scale-110" :style="getStickerStyle(mem.id)">
                                {{ getSticker(mem.id) }}
                            </div>

                            <!-- Photo Frame -->
                            <div class="aspect-square bg-slate-100 overflow-hidden mb-3 border border-slate-100 relative">
                                <img :src="mem.checkInPhoto || mem.image" class="w-full h-full object-cover filter contrast-[1.1] brightness-[1.05]">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            </div>

                            <!-- Handwritten Text -->
                            <div class="font-hand text-slate-800 text-lg leading-none text-center transform -rotate-1">{{ mem.title }}</div>
                            
                            <!-- Truncated Thoughts -->
                            <p class="text-[10px] text-slate-500 font-hand text-center px-1 mt-2 line-clamp-1 text-ellipsis overflow-hidden h-4">
                                {{ mem.checkInThoughts || '......' }}
                            </p>

                            <!-- Date Stamp -->
                            <div class="absolute bottom-2 right-2 font-mono text-[9px] text-orange-400/80 font-bold tracking-widest">'{{ (mem.checkInDate || mem.visitDate).slice(2).replace('-',' ').replace('-','.') }} {{ mem.checkInTime }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === TAB: SUBWAY/MAPS (STYLE RESTORED) === -->
            <div v-if="currentTab === 'subway'" class="p-5 pb-24 bg-bg min-h-full">
                 <div class="flex justify-between items-center mb-6">
                     <h2 class="text-xl font-bold text-slate-800 border-l-4 border-gold pl-3">交通地圖 Maps</h2>
                     <div class="flex gap-2">
                         <button @click="toggleSort('subway', subwayMaps, 'maps-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['subway'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['subway'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                         </button>
                         <button @click="openModal('subway')" class="bg-gold text-white px-3 py-1 rounded-full text-xs font-bold hover:bg-yellow-600 transition-colors shadow-glow">+ 新增</button>
                     </div>
                 </div>
                 <div id="maps-list" class="space-y-4">
                     <div v-for="(map, idx) in subwayMaps" :key="map.id" class="relative group">
                         <h3 class="text-slate-600 text-sm font-bold mb-2 ml-1 flex items-center justify-between">
                            <span>
                                <i v-if="isSorting.subway" class="fa-solid fa-bars drag-handle mr-2 text-slate-400"></i>
                                <i v-else class="fa-solid fa-map mr-2"></i> {{ map.title }}
                            </span>
                         </h3>
                         <div class="rounded-xl overflow-hidden border-2 border-slate-200 relative cursor-zoom-in shadow-md bg-white" @click="!isSorting.subway && viewMap(map)">
                             <img :src="map.image" class="w-full object-cover">
                             <div v-if="!isSorting.subway" class="absolute inset-0 flex items-center justify-center bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-magnifying-glass-plus text-white text-3xl drop-shadow-lg"></i></div>
                         </div>
                         <button v-if="!isSorting.subway" @click="deleteItem('subway', map.id)" class="absolute top-10 right-2 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg"><i class="fa-solid fa-trash text-xs"></i></button>
                     </div>
                     <div v-if="subwayMaps.length === 0" class="flex flex-col items-center justify-center h-64 text-slate-400">
                         <i class="fa-solid fa-map-location-dot text-4xl mb-2 opacity-50"></i>
                         <p class="text-sm">暫無地圖資料</p>
                     </div>
                 </div>
            </div>

            <!-- === TAB: PACKING LIST === -->
            <div v-if="currentTab === 'packing'" class="p-5 pb-24 bg-bg min-h-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800 pl-2 border-l-4 border-gold">行李清單 Packing</h2>
                    <button @click="toggleSort('packing', packingList, 'packing-list')" 
        class="w-8 h-8 rounded-full flex items-center justify-center transition-all"
        :class="isSorting['packing'] ? 'bg-gold text-white shadow-glow' : 'bg-slate-100 text-slate-400 hover:text-gold'">
    
    <i class="fa-solid" :class="isSorting['packing'] ? 'fa-check' : 'fa-arrow-right-arrow-left fa-rotate-90'"></i>
                    </button>
                </div>
                
<div v-if="!isSorting.packing" class="mb-4 flex gap-2 w-full items-center">
                    <input v-model="newPackingItem" @keydown.enter="addPackingItem" placeholder="新增物品..." 
                           class="flex-1 w-0 min-w-0 bg-white border border-slate-200 rounded-xl px-3 py-2 outline-none focus:border-gold text-sm font-bold shadow-inner">
                    
                    <button @click="addPackingItem" 
                            class="w-10 h-10 shrink-0 rounded-xl bg-gradient-to-r from-yellow-100 to-amber-200 hover:from-yellow-200 hover:to-amber-300 text-yellow-900 shadow-md border border-yellow-200 flex items-center justify-center transition-all active:scale-95">
                        <i class="fa-solid fa-plus font-bold"></i>
                    </button>
                </div>

                <div id="packing-list" class="space-y-2">
                    <div v-for="(item, idx) in packingList" :key="item.id" class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-3 group" :class="isSorting.packing ? '' : 'cursor-pointer'" @click="!isSorting.packing && togglePacking(packingList.indexOf(item))">
                        <!-- Drag Handle -->
                        <div v-if="isSorting.packing" class="drag-handle text-slate-300 px-2"><i class="fa-solid fa-bars"></i></div>
                        
                        <div v-if="!isSorting.packing" class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors" :class="item.checked ? 'bg-gold border-gold text-white' : 'border-slate-300 text-transparent'"><i class="fa-solid fa-check text-xs"></i></div>
                        <span class="flex-1 font-bold text-slate-700 transition-all" :class="item.checked && !isSorting.packing ? 'line-through text-slate-400 opacity-50' : ''">{{ item.text }}</span>
                        
                        <button v-if="!isSorting.packing" @click.stop="deletePacking(item.id)" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- ... (Modals, Overlays remain the same) ... -->
    <!-- ... (Keep Crop, Phrase, Modal HTML) ... -->

    <!-- === PHRASE FOCUS OVERLAY === -->
    <div v-if="focusedPhrase" class="fixed inset-0 z-[90] bg-slate-900/95 backdrop-blur-md flex items-center justify-center p-6" @click="focusedPhrase = null">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-10 text-center shadow-2xl transform transition-all relative overflow-hidden" @click.stop>
            <div class="absolute top-0 left-0 w-full h-2 bg-gold"></div>
            <div class="inline-block bg-slate-100 text-slate-500 text-xs font-bold px-3 py-1 rounded-full mb-6 tracking-widest uppercase">{{ focusedPhrase.cat }}</div>
            <div class="mb-8">
                <h2 class="text-6xl font-bold text-slate-900 leading-tight mb-4 select-all">{{ focusedPhrase.jp }}</h2>
            </div>
            <div class="space-y-2 mb-8">
                <p class="text-2xl font-bold text-slate-700">{{ focusedPhrase.cn }}</p>
                <p class="text-sm text-slate-400 font-mono bg-slate-50 inline-block px-3 py-1 rounded-lg">{{ focusedPhrase.romaji }}</p>
            </div>
            <button @click="focusedPhrase = null" class="w-14 h-14 rounded-full bg-slate-900 text-white flex items-center justify-center mx-auto shadow-lg hover:bg-slate-800 hover:scale-110 transition-all">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
    </div>

    <!-- === Universal Modal (Refined Design) === -->
    <div v-if="showModal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center px-4 pb-4 sm:p-0">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @click="closeModal"></div>
        <div class="bg-white relative w-full max-w-sm rounded-[2rem] p-6 shadow-2xl transform transition-all max-h-[90vh] overflow-y-auto no-scrollbar text-slate-700 flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h3 class="font-serif text-lg font-bold text-slate-800">{{ modalTitle }}</h3>
                <button @click="closeModal" class="bg-slate-100 text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <!-- Form Content -->
            <div class="flex-1 space-y-2">
                
                <div v-if="modalType === 'daySettings'" class="space-y-4">
                     <div class="input-fancy-group"><label class="input-fancy-label">每日標題 (Title)</label><input v-model="form.title" class="input-fancy"></div>
                     <div class="input-fancy-group"><label class="input-fancy-label">日期 (Date)</label><input type="date" v-model="form.date" class="input-fancy"></div>
                     <div class="input-fancy-group"><label class="input-fancy-label">描述 (Description)</label><textarea v-model="form.desc" rows="2" class="input-fancy resize-none"></textarea></div>
                     <div class="pt-4"><button @click="removeDay(selectedDayIndex); closeModal()" class="w-full text-red-500 font-bold text-sm bg-red-50 py-3.5 rounded-2xl hover:bg-red-100"><i class="fa-solid fa-trash mr-2"></i> 刪除此日行程</button></div>
                </div>

                <!-- Activity Details / Edit -->
                <template v-if="modalType === 'activity' || modalType === 'activity_details'">
                    <!-- Details View (Optimized Order: Image -> Name -> City -> Date -> Time -> Business Hours -> Address -> Note -> Transport -> Google Maps -> External Links) -->
                    <div v-if="modalType === 'activity_details'" class="space-y-5">
                        <!-- 1. Image -->
                        <div v-if="form.image" class="w-full h-56 rounded-2xl overflow-hidden shadow-md relative"><img :src="form.image" class="w-full h-full object-cover"></div>
                        
                        <!-- 2. Name + 3. City -->
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 leading-tight">{{ form.title }}</h2>
                            <div v-if="form.city" class="mt-2 inline-block bg-blue-50 text-blue-600 text-xs font-bold px-2 py-1 rounded border border-blue-100"><i class="fa-solid fa-location-dot mr-1"></i> {{ form.city }}</div>
                        </div>
                        
                        <!-- 4. Date & 5. Time -->
                        <div class="flex gap-4">
                            <div class="flex-1 bg-slate-50 p-3 rounded-2xl border border-slate-100">
                                <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Date</div>
                                <div class="font-bold text-slate-700">{{ form.visitDate }}</div>
                            </div>
                            <div class="flex-1 bg-slate-50 p-3 rounded-2xl border border-slate-100">
                                <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Time</div>
                                <div class="font-bold text-slate-700">{{ form.time }}</div>
                            </div>
                        </div>

                        <!-- 6. Business Hours -->
                        <div v-if="form.businessHours" class="bg-slate-50 p-3 rounded-2xl border border-slate-100">
                             <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Business Hours</div>
                             <div class="font-bold text-slate-700 text-sm"><i class="fa-regular fa-clock mr-1"></i> {{ form.businessHours }}</div>
                             <!-- Address inside Business Hours block -->
                             <div v-if="form.location" class="mt-2 pt-2 border-t border-slate-200 text-xs text-slate-600 flex items-start gap-2">
                                 <i class="fa-solid fa-location-dot text-slate-400 w-4 text-center mt-0.5"></i>
                                 <span>{{ form.location }}</span>
                             </div>
                        </div>

                        <!-- 7. Description (Note) - Title Restored Here -->
                        <div v-if="form.note" class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div class="text-[10px] text-slate-400 font-bold uppercase mb-2 flex items-center gap-1">
                                <i class="fa-solid fa-align-left"></i> 備註 / Description
                            </div>
                            <div class="text-sm text-slate-600 leading-relaxed" v-html="form.note"></div>
                        </div>
                        
                        <!-- 8. Transport -->
                        <div v-if="form.nextTransport && form.nextTransport.mode" class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
                            <div class="text-[10px] text-blue-400 font-bold uppercase mb-2">Transport</div>
                            <div v-html="form.nextTransport.mode" :class="form.nextTransport.isRichText ? 'text-xs' : 'font-bold text-blue-800 flex items-center gap-2'"></div>
                        </div>

                        <!-- 9. Google Maps Link -->
                        <div class="mt-2">
                            <a :href="form.mapUrl || 'https://www.google.com/maps/search/?api=1&query=' + (form.location || form.title)" target="_blank" class="block w-full text-center bg-blue-50 text-blue-600 border border-blue-200 font-bold py-3 rounded-xl hover:bg-blue-100 transition-colors shadow-sm">
                                <i class="fa-solid fa-map-location-dot mr-2"></i> Open in Google Maps
                            </a>
                        </div>

                        <!-- 10. External Links -->
                        <div v-if="form.externalLinks && form.externalLinks.length > 0" class="mt-3 flex flex-wrap gap-2">
                            <a v-for="(link, idx) in form.externalLinks" :key="idx" :href="link.url" target="_blank" class="px-3 py-2 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-200 flex items-center gap-2">
                                <i class="fa-solid fa-link"></i> {{ link.name || 'Link' }}
                            </a>
                        </div>
                    </div>

                    <!-- Edit Form (Styled & Fancy) -->
                    <div v-else class="space-y-4">
                        <!-- Image Upload Area -->
                        <div class="relative group">
                            <label class="block w-full h-40 rounded-2xl border-2 border-dashed border-slate-200 hover:border-gold bg-slate-50 hover:bg-white transition-all cursor-pointer overflow-hidden relative">
                                <input type="file" class="hidden" accept="image/*" @change="(e) => handleImageUpload(e, 'activity')">
                                <img v-if="form.image" :src="form.image" class="w-full h-full object-cover absolute inset-0">
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400" :class="form.image ? 'bg-black/30 text-white opacity-0 group-hover:opacity-100 transition-opacity' : ''">
                                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mb-2"><i class="fa-solid fa-camera text-xl"></i></div>
                                    <span class="text-xs font-bold">{{ form.image ? '更換照片' : '上傳封面照片' }}</span>
                                </div>
                            </label>
                        </div>

                        <div class="input-fancy-group"><label class="input-fancy-label">名稱 (Name)</label><input v-model="form.title" class="input-fancy" placeholder="e.g. 清水寺"></div>
                        
                        <div class="flex gap-3">
                            <div class="input-fancy-group flex-1"><label class="input-fancy-label">日期 (Date)</label><input v-model="form.visitDate" type="date" class="input-fancy"></div>
                            <div class="input-fancy-group flex-1"><label class="input-fancy-label">時間 (Time)</label><input v-model="form.time" type="time" class="input-fancy"></div>
                        </div>

                        <!-- Added Business Hours Input -->
                        <div class="flex gap-3">
                            <div class="input-fancy-group"><label class="input-fancy-label">營業時間 (businessHours)</label><input v-model="form.businessHours" class="input-fancy" placeholder="08:00~22:00"></div>
                            <div class="input-fancy-group"><label class="input-fancy-label">城市 (City)</label><input v-model="form.city" class="input-fancy" placeholder="Osaka"></div>
                        </div>

                        <!-- SPLIT Location and Map URL -->
                        <div class="input-fancy-group"><label class="input-fancy-label">地點 / 地址 (Location/Address)</label><input v-model="form.location" class="input-fancy" placeholder="地址或地標名稱"></div>
                        <div class="input-fancy-group"><label class="input-fancy-label">Google Maps 連結</label><input v-model="form.mapUrl" class="input-fancy" placeholder="https://maps.app.goo.gl/..."></div>
                        
                        <div class="flex gap-3">
                             <div class="input-fancy-group flex-[2]">
                                 <label class="input-fancy-label">類型 (Type)</label>
                                 <div class="mb-4">
                                     <label class="block text-sm font-bold text-slate-700 mb-2 ml-1"></label>
    
                                     <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
        
                                         <button type="button" @click="form.type = 'spot'" 
                                             class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 h-20"
                                             :class="form.type === 'spot' ? 'bg-yellow-50 border-yellow-500 text-yellow-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50 hover:text-slate-600'">
                                             <i class="fa-solid fa-camera-retro text-xl mb-1.5"></i>
                                             <span class="text-xs font-bold">Spot</span>
                                         </button>

                                         <button type="button" @click="form.type = 'food'" 
                                             class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 h-20"
                                             :class="form.type === 'food' ? 'bg-yellow-50 border-yellow-500 text-yellow-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50 hover:text-slate-600'">
                                             <i class="fa-solid fa-utensils text-xl mb-1.5"></i>
                                             <span class="text-xs font-bold">Restaurant</span>
                                         </button>

                                         <button type="button" @click="form.type = 'shopping'" 
                                             class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 h-20"
                                             :class="form.type === 'shopping' ? 'bg-yellow-50 border-yellow-500 text-yellow-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50 hover:text-slate-600'">
                                             <i class="fa-solid fa-bag-shopping text-xl mb-1.5"></i>
                                             <span class="text-xs font-bold">Shopping</span>
                                         </button>

                                         <button type="button" @click="form.type = 'temple'" 
                                             class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 h-20"
                                             :class="form.type === 'temple' ? 'bg-yellow-50 border-yellow-500 text-yellow-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50 hover:text-slate-600'">
                                             <i class="fa-solid fa-torii-gate text-xl mb-1.5"></i>
                                             <span class="text-xs font-bold">Temple</span>
                                         </button>

                                         <button type="button" @click="form.type = 'fun'" 
                                             class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 h-20"
                                             :class="form.type === 'fun' ? 'bg-yellow-50 border-yellow-500 text-yellow-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50 hover:text-slate-600'">
                                             <i class="fa-solid fa-ticket text-xl mb-1.5"></i>
                                             <span class="text-xs font-bold">Fun</span>
                                         </button>

                                         <button type="button" @click="form.type = 'citytour'" 
                                             class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 h-20"
                                             :class="form.type === 'citytour' ? 'bg-yellow-50 border-yellow-500 text-yellow-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50 hover:text-slate-600'">
                                             <i class="fa-solid fa-city text-xl mb-1.5"></i>
                                             <span class="text-xs font-bold">City Tour</span>
                                         </button>

                                         <button type="button" @click="form.type = 'nature'" 
                                             class="flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all duration-200 h-20"
                                             :class="form.type === 'nature' ? 'bg-yellow-50 border-yellow-500 text-yellow-700 shadow-md scale-105' : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50 hover:text-slate-600'">
                                             <i class="fa-solid fa-tree text-xl mb-1.5"></i>
                                             <span class="text-xs font-bold">Nature</span>
                                         </button>

                                     </div>
                                 </div>
                             </div>
                        </div>

                        <div class="input-fancy-group">
                            <label class="input-fancy-label mb-2">描述 / 備註 (Note)</label>
                            <div class="w-full bg-white rounded-lg border border-slate-200 p-3 min-h-[80px] max-h-[150px] overflow-y-auto text-sm focus-within:border-gold/50 outline-none empty:before:content-[attr(placeholder)] empty:before:text-slate-300"
                                 contenteditable="true"
                                 ref="noteInput"
                                 @input="form.note = $event.target.innerHTML"
                                 placeholder="可貼上 Rich Text 格式內容...">
                            </div>
                        </div>

                        <!-- External Links Section -->
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                             <div class="flex justify-between items-center mb-3">
                                 <label class="input-fancy-label mb-0">路線規劃 (Route)</label>
                                 <div class="flex bg-slate-200 rounded-lg p-0.5"><button @click="form.nextTransport.isRichText=false" class="px-2 py-1 rounded-md text-[10px] font-bold transition-all" :class="!form.nextTransport.isRichText?'bg-white shadow-sm text-slate-800':'text-slate-500'">設計</button><button @click="form.nextTransport.isRichText=true" class="px-2 py-1 rounded-md text-[10px] font-bold transition-all" :class="form.nextTransport.isRichText?'bg-white shadow-sm text-slate-800':'text-slate-500'">貼上</button></div>
                             </div>
                             
                             <div v-if="!form.nextTransport.isRichText">
                                 <div class="flex gap-2 mb-2 overflow-x-auto pb-2 no-scrollbar"><button v-for="c in transportColors" :key="c" @click="form.nextTransport.style={color:c}" class="w-5 h-5 rounded-full border border-white shadow-sm shrink-0" :style="{background: getTransportColor(c).bg}" :class="{'ring-2 ring-slate-400': form.nextTransport.style?.color===c}"></button></div>
                                 <div class="relative"><input v-model="form.nextTransport.mode" class="w-full bg-white border border-slate-200 rounded-xl p-3 text-sm focus:border-gold outline-none" placeholder="e.g. JR線 -> 公車"><div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400 font-bold px-2 py-1 bg-slate-100 rounded">Badge</div></div>
                             </div>
                             <div v-else>
                                 <div class="w-full bg-white border border-slate-200 rounded-xl p-3 min-h-[60px] text-sm focus-within:border-gold outline-none empty:before:content-[attr(placeholder)] empty:before:text-slate-300" contenteditable="true" ref="transportRichInput" @input="form.nextTransport.mode=$event.target.innerHTML" placeholder="直接貼上 Google Maps 路線..."></div>
                             </div>
                        </div>

                        <div class="input-fancy-group">
                            <div class="flex justify-between items-center mb-2">
                                <label class="input-fancy-label mb-0">外部連結 (External Links)</label>
                                <button @click="addExternalLink" class="text-xs bg-slate-200 px-2 py-1 rounded hover:bg-slate-300 text-slate-600"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <div v-for="(link, idx) in form.externalLinks" :key="idx" class="flex gap-2 mb-2 items-center">
                                <input v-model="link.name" class="input-fancy border-b border-slate-200 text-xs w-1/3" placeholder="名稱">
                                <input v-model="link.url" class="input-fancy border-b border-slate-200 text-xs flex-1" placeholder="URL">
                                <button @click="form.externalLinks.splice(idx, 1)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-minus"></i></button>
                            </div>
                            <div v-if="!form.externalLinks || form.externalLinks.length === 0" class="text-center text-xs text-slate-400">尚無連結</div>
                        </div>

                    </div>
                </template>

                <!-- Check-in Form -->
                <div v-if="modalType === 'checkin'" class="space-y-4">
                     <label class="block w-full h-48 rounded-2xl border-2 border-dashed border-slate-200 hover:border-gold bg-slate-50 hover:bg-white transition-all cursor-pointer overflow-hidden relative">
                        <input type="file" class="hidden" accept="image/*" @change="(e) => handleImageUpload(e, 'checkin')">
                        <img v-if="form.checkInPhoto" :src="form.checkInPhoto" class="w-full h-full object-cover absolute inset-0">
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400" :class="form.checkInPhoto ? 'bg-black/30 text-white opacity-0 group-hover:opacity-100 transition-opacity' : ''">
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center mb-2"><i class="fa-solid fa-camera text-2xl"></i></div>
                            <span class="text-xs font-bold">{{ form.checkInPhoto ? '更換照片' : '上傳打卡照' }}</span>
                        </div>
                    </label>
                    <div class="flex gap-3">
                        <div class="input-fancy-group flex-1"><label class="input-fancy-label">日期</label><input v-model="form.checkInDate" type="date" class="input-fancy"></div>
                        <div class="input-fancy-group flex-1"><label class="input-fancy-label">時間</label><input v-model="form.checkInTime" type="time" class="input-fancy"></div>
                    </div>
                    <div class="input-fancy-group"><label class="input-fancy-label">心得感想</label><textarea v-model="form.checkInThoughts" class="input-fancy resize-none h-24" placeholder="記錄當下的心情..."></textarea></div>
                </div>

                <!-- Memory Details (New) -->
                <div v-if="modalType === 'memory_details'" class="space-y-4">
                    <div class="bg-white p-4 pb-8 shadow-lg border border-slate-100 relative rotate-1" :style="getPolaroidStyle(form.id)">
                        <!-- Tape -->
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 bg-red-400/80 rotate-1 shadow-sm z-20 mask-tape"></div>
                        
                        <!-- Photo -->
                        <div class="aspect-square bg-slate-100 overflow-hidden mb-4 border border-slate-100 relative">
                            <img :src="form.checkInPhoto || form.image" class="w-full h-full object-cover">
                        </div>

                        <!-- Title -->
                        <div class="font-hand text-slate-800 text-2xl leading-none text-center mb-2">{{ form.title }}</div>
                        
                        <!-- Date -->
                        <div class="text-center font-mono text-xs text-slate-400 mb-4 border-b border-dashed border-slate-200 pb-2">
                            {{ form.checkInDate }} {{ form.checkInTime }}
                        </div>

                        <!-- Thoughts (Full Text) -->
                        <div class="text-sm text-slate-600 font-hand leading-relaxed px-2 text-center whitespace-pre-wrap max-h-40 overflow-y-auto">
                            {{ form.checkInThoughts }}
                        </div>
                    </div>
                </div>

                <!-- Flight Form -->
                <div v-if="modalType === 'flight' || modalType === 'ticket_flight'" class="space-y-4">
    <!-- ... (Flight Form Content) ... -->
    <div class="input-fancy-group">
        <label class="input-fancy-label">航空公司</label>
        <select v-model="form.airline" class="input-fancy">
            <option v-for="(data, key) in airlineData" :key="key" :value="key">
                {{ data.name }} ({{ key }})
            </option>
        </select>
    </div>

    <!-- NEW: Passenger Input -->
    <div class="input-fancy-group">
        <label class="input-fancy-label">乘客姓名 (Passenger)</label>
        <input v-model="form.passenger" class="input-fancy" placeholder="e.g. MEMBERS">
    </div>

    <div class="flex gap-3">
        <div class="input-fancy-group flex-1">
            <label class="input-fancy-label">航班號</label>
            <input v-model="form.number" class="input-fancy">
        </div>
        <div class="input-fancy-group flex-1">
            <label class="input-fancy-label">艙等</label>
            <select v-model="form.class" class="input-fancy">
                <option value="ECONOMY">Economy</option>
                <option value="BUSINESS">Business</option>
            </select>
        </div>
    </div>

    <div class="flex gap-3">
        <div class="input-fancy-group flex-1">
            <label class="input-fancy-label">日期</label>
            <input v-model="form.date" type="date" class="input-fancy">
        </div>
    </div>

    <div class="grid grid-cols-2 gap-3">
        <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100">
            <label class="input-fancy-label">出發 (DEP)</label>
            <input v-model="form.depCode" class="input-fancy font-mono text-lg" placeholder="TPE">
            <input v-model="form.depTime" type="time" class="input-fancy mt-1">
        </div>
        <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100">
            <label class="input-fancy-label">抵達 (ARR)</label>
            <input v-model="form.arrCode" class="input-fancy font-mono text-lg" placeholder="KIX">
            <input v-model="form.arrTime" type="time" class="input-fancy mt-1">
        </div>
    </div>

    <div class="flex gap-3">
        <div class="input-fancy-group flex-1">
            <label class="input-fancy-label">登機門 (Gate)</label>
            <input v-model="form.gate" class="input-fancy font-mono text-center" placeholder="--">
        </div>
        <div class="input-fancy-group flex-1">
            <label class="input-fancy-label">座位號 (Seat)</label>
            <input v-model="form.seat" class="input-fancy font-mono text-center" placeholder="--">
        </div>
    </div>

</div>

                <!-- Expense Form (Upgrade 1 & 2) -->
                <div v-if="modalType === 'expense'" class="space-y-4">
                    <!-- ... (Expense Form Content) ... -->
                    <!-- 1. Date -->
                    <div class="input-fancy-group"><label class="input-fancy-label">日期 (Date)</label><input v-model="form.date" type="date" class="input-fancy"></div>

                    <!-- 2. Item Name -->
                    <div class="input-fancy-group"><label class="input-fancy-label">消費項目</label><input v-model="form.item" class="input-fancy" placeholder="e.g. 章魚燒"></div>

                    <!-- 3. Category Selection -->
                    <div>
                        <label class="input-fancy-label mb-2">消費分類</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button v-for="type in expenseTypes" :key="type.value" @click="form.category = type.value"
                                class="flex flex-col items-center justify-center p-2 rounded-xl border transition-all duration-200 h-16"
                                :class="form.category === type.value ? 'bg-yellow-50 border-gold text-yellow-700 shadow-sm' : 'bg-white border-slate-100 text-slate-400 hover:bg-slate-50'">
                                <i :class="type.icon" class="mb-1 text-lg"></i>
                                <span class="text-[10px] font-bold">{{ type.label }}</span>
                            </button>
                        </div>
                    </div>

                    <!-- 4. Payment Method -->
                    <div>
                        <label class="input-fancy-label mb-2">付款方式</label>
                        <div class="flex gap-2">
                            <button v-for="pm in paymentMethods" :key="pm.value" @click="form.payment = pm.value"
                                class="flex-1 py-3 rounded-xl flex items-center justify-center gap-2 border transition-all"
                                :class="form.payment === pm.value ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-400 border-slate-200'">
                                <i :class="pm.icon"></i> <span class="text-xs font-bold">{{ pm.label }}</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 5. Amount & Currency -->
                    <div class="flex gap-3">
                        <div class="input-fancy-group w-24"><label class="input-fancy-label">幣別</label>
                            <select v-model="form.currency" class="input-fancy font-mono text-center text-xs">
                                <option value="JPY">JPY</option>
                                <option value="TWD">TWD</option>
                                <option value="USD">USD</option>
                                <option value="KRW">KRW</option>
                                <option value="CNY">CNY</option>
                                <option value="HKD">HKD</option>
                            </select>
                        </div>
                        <div class="input-fancy-group flex-1"><label class="input-fancy-label">金額</label><input v-model="form.amount" type="number" class="input-fancy font-mono text-lg"></div>
                    </div>

                    <!-- Payer -->
                    <div><label class="input-fancy-label mb-2">付款人 (Who paid?)</label><div class="flex gap-2"><button v-for="m in members" :key="m" @click="form.payer=m" class="flex-1 py-2.5 rounded-xl text-xs font-bold border transition-all" :class="form.payer===m?'bg-gold text-white border-gold shadow-md':'bg-white text-slate-400 border-slate-200'">{{m}}</button></div></div>
                    
                    <!-- 6. Split Mode -->
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <label class="input-fancy-label mb-2">分帳模式</label>
                        <div class="flex bg-slate-200 p-1 rounded-xl mb-3">
                            <button v-for="mode in splitModes" :key="mode.value" @click="form.splitMode = mode.value"
                                class="flex-1 py-2 rounded-lg text-xs font-bold transition-all"
                                :class="form.splitMode === mode.value ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'">
                                {{ mode.label }}
                            </button>
                        </div>
                        
                        <!-- Advance Payment Details -->
                        <div v-if="form.splitMode === 'advance'" class="animate-fade-in">
                            <label class="input-fancy-label mb-2 text-orange-500">幫誰代墊? (可複選 & 填金額)</label>
                            <div class="space-y-2">
                                <div v-for="m in members" :key="m" class="flex items-center gap-2">
                                    <!-- Checkbox/Toggle -->
                                    <button @click="toggleAdvanceMember(m)" 
                                            class="w-8 h-8 rounded-lg border flex items-center justify-center transition-all"
                                            :class="form.advanceSplits && form.advanceSplits[m] !== undefined ? 'bg-orange-500 text-white border-orange-500' : 'bg-white border-slate-300 text-slate-300'">
                                        <i class="fa-solid fa-check text-xs"></i>
                                    </button>
                                    <span class="text-sm font-bold text-slate-700 w-16">{{ m }}</span>
                                    <!-- Amount Input (Only if selected) -->
                                    <div class="flex-1" v-if="form.advanceSplits && form.advanceSplits[m] !== undefined">
                                        <input type="number" v-model.number="form.advanceSplits[m]" class="w-full bg-white border border-slate-200 rounded-lg px-2 py-1 text-sm font-mono" placeholder="金額">
                                    </div>
                                    <div class="flex-1 text-xs text-slate-400" v-else>未選擇</div>
                                </div>
                            </div>
                            <div class="mt-2 text-right text-xs font-bold" :class="advanceTotal === form.amount ? 'text-green-500' : 'text-red-400'">
                                合計: {{ advanceTotal }} / {{ form.amount }}
                            </div>
                        </div>
                         <div v-if="form.splitMode === 'self'" class="text-[10px] text-slate-400 text-center">
                            * 此筆費用將歸算在付款人個人帳上，不列入公帳。
                        </div>
                    </div>
                </div>

                <!-- Hotel, Train, Spot forms ... -->
<div v-if="modalType === 'hotel'" class="space-y-4">
                    <div class="input-fancy-group">
                        <label class="input-fancy-label">飯店名稱</label>
                        <input v-model="form.name" class="input-fancy" placeholder="e.g. 大阪希爾頓">
                    </div>
                    
                    <div class="input-fancy-group">
                        <label class="input-fancy-label">地址 (Address)</label>
                        <input v-model="form.address" class="input-fancy" placeholder="輸入飯店地址以利導航">
                    </div>
                    
                    <div class="input-fancy-group">
                        <label class="input-fancy-label">電話 (Phone)</label>
                        <input v-model="form.phone" type="tel" class="input-fancy" placeholder="+81 6-1234-5678">
                    </div>

                    <div class="flex gap-3">
                        <div class="input-fancy-group flex-1">
                            <label class="input-fancy-label">Check-in</label>
                            <input v-model="form.checkIn" type="date" class="input-fancy">
                        </div>
                        <div class="input-fancy-group flex-1">
                            <label class="input-fancy-label">Check-out</label>
                            <input v-model="form.checkOut" type="date" class="input-fancy">
                        </div>
                    </div>
                    
                    <div class="input-fancy-group">
                        <label class="input-fancy-label">備註 (Booking Ref/Notes)</label>
                        <input v-model="form.notes" class="input-fancy" placeholder="訂房代號或其他備註...">
                    </div>

                    <label class="block w-full h-32 rounded-2xl border-2 border-dashed border-slate-200 hover:border-gold bg-slate-50 flex flex-col items-center justify-center text-slate-400 cursor-pointer">
                        <input type="file" class="hidden" accept="image/*" @change="(e) => handleImageUpload(e, 'hotel')">
                        <i class="fa-solid fa-image mb-1"></i><span class="text-xs font-bold">上傳照片</span>
                    </label>
                </div>                
                 <!-- Subway Map Upload Form -->
                <div v-if="modalType === 'subway'" class="space-y-4">
                    <div class="input-fancy-group"><label class="input-fancy-label">地圖名稱</label><input v-model="form.title" class="input-fancy" placeholder="e.g. 大阪地鐵圖"></div>
                     <label class="block w-full h-48 rounded-2xl border-2 border-dashed border-slate-200 hover:border-gold bg-slate-50 hover:bg-white transition-all cursor-pointer overflow-hidden relative">
                        <input type="file" class="hidden" accept="image/*" @change="(e) => handleImageUpload(e, 'subway')">
                        <img v-if="form.image" :src="form.image" class="w-full h-full object-contain absolute inset-0">
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400" :class="form.image ? 'bg-black/30 text-white opacity-0 group-hover:opacity-100 transition-opacity' : ''">
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center mb-2"><i class="fa-solid fa-image text-2xl"></i></div>
                            <span class="text-xs font-bold">{{ form.image ? '更換圖片' : '上傳地圖圖片' }}</span>
                        </div>
                    </label>
                </div>
                
                <!-- Ticket Spot Form -->
                <div v-if="modalType === 'ticket_spot'" class="space-y-4">
                     <div class="input-fancy-group"><label class="input-fancy-label">景點名稱</label><input v-model="form.name" class="input-fancy" placeholder="e.g. 環球影城"></div>
                     <div class="flex gap-3">
                         <div class="input-fancy-group w-24"><label class="input-fancy-label">幣別</label><input v-model="form.currency" class="input-fancy font-mono text-center" placeholder="JPY"></div>
                         <div class="input-fancy-group flex-1"><label class="input-fancy-label">價格</label><input v-model="form.price" type="number" class="input-fancy font-mono"></div>
                     </div>
                     <div class="input-fancy-group"><label class="input-fancy-label">日期</label><input v-model="form.date" type="date" class="input-fancy"></div>
                     <label class="block w-full h-32 rounded-2xl border-2 border-dashed border-slate-200 hover:border-gold bg-slate-50 flex flex-col items-center justify-center text-slate-400 cursor-pointer"><input type="file" class="hidden" accept="image/*" @change="(e) => handleImageUpload(e, 'ticket_spot')"><i class="fa-solid fa-image mb-1"></i><span class="text-xs font-bold">上傳封面</span></label>
                </div>
                
                <!-- Ticket Train Form -->
                <div v-if="modalType === 'trainInfo' || modalType === 'ticket_train'" class="space-y-4">
                    <div class="input-fancy-group"><label class="input-fancy-label">列車名稱</label><input v-model="form.name" class="input-fancy" placeholder="e.g. HARUKA 14號"></div>
                    <div class="input-fancy-group"><label class="input-fancy-label">日期</label><input v-model="form.date" type="date" class="input-fancy"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100"><label class="input-fancy-label">出發</label><input v-model="form.depStation" class="input-fancy" placeholder="關西機場"><input v-model="form.depTime" type="time" class="input-fancy mt-1"></div>
                        <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100"><label class="input-fancy-label">抵達</label><input v-model="form.arrStation" class="input-fancy" placeholder="京都"><input v-model="form.arrTime" type="time" class="input-fancy mt-1"></div>
                    </div>
                     <div class="flex gap-2">
                        <div class="input-fancy-group flex-1"><label class="input-fancy-label">車廂</label><input v-model="form.car" class="input-fancy text-center"></div>
                        <div class="input-fancy-group flex-1"><label class="input-fancy-label">座位</label><input v-model="form.seat" class="input-fancy text-center"></div>
                    </div>
                    <div class="input-fancy-group"><label class="input-fancy-label">類型</label><select v-model="form.trainType" class="input-fancy bg-transparent"><option value="Haruka">Haruka</option><option value="Shinkansen">新幹線</option><option value="Subway">地鐵/私鐵</option><option value="Sightseeing">觀光列車</option><option value="CableCar">纜車</option></select></div>
                </div>

                <!-- New Phrase Form -->
                <div v-if="modalType === 'phrase'" class="space-y-4">
                    <div class="input-fancy-group"><label class="input-fancy-label">類別 (Category)</label><input v-model="form.cat" class="input-fancy" placeholder="e.g. 購物"></div>
                    <div class="input-fancy-group"><label class="input-fancy-label">日文 (Japanese)</label><input v-model="form.jp" class="input-fancy text-lg" placeholder="こんにちは"></div>
                    <div class="input-fancy-group"><label class="input-fancy-label">中文 (Meaning)</label><input v-model="form.cn" class="input-fancy" placeholder="你好"></div>
                    <div class="input-fancy-group"><label class="input-fancy-label">羅馬拼音 (Romaji)</label><input v-model="form.romaji" class="input-fancy font-mono" placeholder="Konnichiwa"></div>
                </div>

            </div>

            <!-- Footer Actions -->
<div class="pt-6 mt-4 border-t border-slate-100 flex gap-3">
                
                <template v-if="modalType.includes('_details')">
                    <button type="button" @click="killItem" class="flex-1 py-3.5 rounded-2xl bg-red-50 text-red-500 font-bold text-sm hover:bg-red-100 transition-colors border border-red-100">
                        <i class="fa-solid fa-trash-can mr-1"></i> 刪除
                    </button>
                    <button type="button" @click="switchToEdit" class="flex-[2] py-3.5 rounded-2xl bg-slate-900 text-white font-bold text-sm shadow-lg hover:bg-slate-800 transition-colors">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> 編輯內容
                    </button>
                </template>

                <template v-else-if="modalType === 'daySettings'">
                    <button type="button" @click="closeModal" class="flex-1 py-3.5 rounded-2xl bg-slate-100 text-slate-500 font-bold text-sm hover:bg-slate-200 transition-colors">
                        取消
                    </button>
                    <button type="button" @click="killItem" class="flex-1 py-3.5 rounded-2xl bg-red-50 text-red-500 font-bold text-sm hover:bg-red-100 transition-colors">
                        刪除整天
                    </button>
                    <button type="button" @click="saveItem" class="flex-[2] py-3.5 rounded-2xl bg-gradient-to-r from-yellow-100 to-amber-200 hover:from-yellow-200 hover:to-amber-300 text-yellow-900 font-bold text-sm shadow-md shadow-yellow-200/50 border border-yellow-200 transition-all active:scale-95">
                        儲存
                    </button>
                </template>

                <template v-else>
                    <button v-if="isEditing" type="button" @click="killItem" class="w-12 py-3.5 rounded-2xl bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition-colors">
                        <i class="fa-regular fa-trash-can"></i>
                    </button>

                    <button type="button" @click="closeModal" class="flex-1 py-3.5 rounded-2xl bg-slate-100 text-slate-500 font-bold text-sm hover:bg-slate-200 transition-colors">
                        取消
                    </button>
                    
                    <button type="button" @click="saveItem" class="flex-[2] py-3.5 rounded-2xl bg-gradient-to-r from-yellow-100 to-amber-200 hover:from-yellow-200 hover:to-amber-300 text-yellow-900 font-bold text-sm shadow-md shadow-yellow-200/50 border border-yellow-200 flex items-center justify-center gap-2 transition-all active:scale-95">
                        <i class="fa-solid" :class="isEditing ? 'fa-floppy-disk' : 'fa-plus'"></i>
                        {{ isEditing ? '儲存' : '新增' }}
                    </button>
                </template>

            </div>
        </div>
    </div>

    <!-- Zoomed Image Overlay -->
    <div v-if="zoomedImage" 
         class="fixed inset-0 z-[200] bg-black/95 backdrop-blur-sm flex items-center justify-center p-2 cursor-zoom-out transition-opacity duration-300"
         @click="zoomedImage = null">
        
        <img :src="zoomedImage" 
             class="max-w-full max-h-full object-contain rounded-lg shadow-2xl"
             @click.stop> 
        <button @click="zoomedImage = null" 
                class="absolute top-6 right-6 w-12 h-12 bg-white/20 text-white rounded-full flex items-center justify-center hover:bg-white/30 backdrop-blur-md transition-all">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
    </div>


<script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() 
        {
            // --- ★★★ 記憶頁面狀態邏輯 ★★★ ---
            // 1. 嘗試從手機讀取「上次停在哪一頁」
            let savedState = { tab: 'itinerary', day: 0 };
            try {
                const rawState = localStorage.getItem('app_ui_state_v1');
                if (rawState) savedState = JSON.parse(rawState);
            } catch(e) {}

            // 2. 使用讀取到的值來初始化變數
            const currentTab = ref(savedState.tab);
            const selectedDayIndex = ref(savedState.day);

            // 3. 監聽變數改變，隨時存檔 (這樣重整時就能讀到最新的)
            watch([currentTab, selectedDayIndex], ([newTab, newDay]) => {
                localStorage.setItem('app_ui_state_v1', JSON.stringify({
                    tab: newTab,
                    day: newDay
                }));
            });
            // ------------------------------------

            // --- ★★★ Firebase 設定區 (請填入你的資料) ★★★ ---
 const firebaseConfig = {
    apiKey: "AIzaSyBgyjm9y3sIUiizDDvg9JJmLSzQqA-r89Q",
    authDomain: "kyoto-osaka-426bd.firebaseapp.com",
    databaseURL: "https://kyoto-osaka-426bd-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kyoto-osaka-426bd",
    storageBucket: "kyoto-osaka-426bd.firebasestorage.app",
    messagingSenderId: "123754365058",
    appId: "1:123754365058:web:27622e0d0cae72c5fb749b",
    measurementId: "G-0XZFQ6GSPL"
  };
            
            // 初始化 Firebase
            // 避免重複初始化報錯
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.database();
            const tripId = 'Osaka_Kyoto_Team_2025'; // 這是你們的「房間號碼」，大家都一樣才看得到彼此
            
            // 防止無限迴圈的鎖
            const isRemoteUpdate = ref(false);
            // ... (Previous setup logic unchanged) ...
            const noteInput = ref(null);
            const transportRichInput = ref(null); 
            
            // Sorting State
            const isSorting = ref({ 
                itinerary: false, 
                packing: false, 
                subway: false,
                flights: false,
                trains: false,
                hotels: false,
                ticket_flights: false,
                ticket_trains: false,
                ticket_spots: false,
                memories: false
            });
            let sortableInstance = null;

            // Fixed Navigation Logic
            const selectDay = (index) => {
                selectedDayIndex.value = index;
                currentTab.value = 'itinerary';
                nextTick(() => document.getElementById('mainContent').scrollTop = 0);
            };
            
            const showModal = ref(false);
            const modalType = ref('activity'); 
            const isEditing = ref(false);
            const editingId = ref(null);
            const mapInstance = ref(null);
            const markersLayer = ref(null);
            const zoomedImage = ref(null);
            const isZoomedIn = ref(false);
            const newPackingItem = ref("");
            const expandedMember = ref(null);
            
            // AI Chat State
            const aiInput = ref("");
            const isAiThinking = ref(false);
            const aiMessages = ref([
                { role: 'ai', text: '您好，我是您的關西旅遊管家。很高興為您服務。關於大阪或京都的行程、交通、美食，有任何需要協助的地方嗎？' }
            ]);

            // ... (JP Phrases data) ...
            const showJPHelp = ref(false); 
            const focusedPhrase = ref(null); 
            const jpPhrases = ref([
                { id: 'jp1', cat: '基本', jp: 'すみません', cn: '不好意思 / 請問', romaji: 'Sumimasen' },
                { id: 'jp2', cat: '基本', jp: 'ありがとう', cn: '謝謝', romaji: 'Arigatou' },
                { id: 'jp3', cat: '購物', jp: 'これいくらですか？', cn: '這個多少錢？', romaji: 'Kore ikura desu ka?' },
                { id: 'jp4', cat: '購物', jp: '免税できますか？', cn: '可以退稅嗎？', romaji: 'Men-zei dekimasu ka?' },
                { id: 'jp5', cat: '餐廳', jp: '予約してあります', cn: '我有訂位', romaji: 'Yoyaku Shiteimasu' },
                { id: 'jp6', cat: '餐廳', jp: '中国語のメニューはありますか？', cn: '有中文菜單嗎?', romaji: 'Chuugokugo no menyu wa arimasuka' },
                { id: 'jp7', cat: '餐廳', jp: 'お会計お願いします', cn: '麻煩結帳', romaji: 'O-kaikei onegaishimasu' },
                { id: 'jp8', cat: '餐廳', jp: 'お水ください', cn: '請給我水', romaji: 'Omizu kudasai' },
                { id: 'jp9', cat: '交通', jp: '駅はどこですか？', cn: '車站在哪裡？', romaji: 'Eki wa doko desu ka?' },
                { id: 'jp10', cat: '住宿', jp: 'チェックインしたいです', cn: '我想辦理入住', romaji: 'Check-in shitai desu' },
            ]);

            const currencySearch = ref("");
            const modalCurrencySearch = ref("");
            const showCurrencyList = ref(false);
            const showModalCurrency = ref(false);

            const members = ref(["邱", "李", "蘇", "詹"]);
            const currencyRates = ref({ "TWD": 1, "JPY": 0.215, "USD": 32.5 });
            const allCurrencies = ref([]); 
            const calcCurrency = ref("JPY");
            const calcAmount = ref(1000);
            const transportColors = ['red','orange','yellow','green','blue','indigo','purple','pink','brown','gray'];
            const commonCurrencies = { "USD": "美金", "JPY": "日圓", "EUR": "歐元", "KRW": "韓元", "CNY": "人民幣", "HKD": "港幣", "TWD": "新台幣", "GBP": "英鎊", "AUD": "澳幣" };
            
            // ... (Expense Types and Payment Methods) ...
            const expenseTypes = ref([
                { value: 'food', label: '餐飲美食', icon: 'fa-solid fa-utensils' },
                { value: 'transport', label: '交通移動', icon: 'fa-solid fa-train-subway' },
                { value: 'shopping', label: '購物消費', icon: 'fa-solid fa-bag-shopping' },
                { value: 'ticket', label: '門票體驗', icon: 'fa-solid fa-ticket' },
                { value: 'hotel', label: '住宿飯店', icon: 'fa-solid fa-bed' },
                { value: 'other', label: '其他雜支', icon: 'fa-solid fa-circle-question' }
            ]);

            const paymentMethods = ref([
                { value: 'cash', label: '現金', icon: 'fa-solid fa-coins' },
                { value: 'card', label: '刷卡', icon: 'fa-regular fa-credit-card' }
            ]);

            const splitModes = ref([
                { value: 'split_all', label: '共同分擔' },
                { value: 'self', label: '個人自付' },
                { value: 'advance', label: '幫人代墊' }
            ]);

            // ... (Airline Data unchanged) ...
            const airlineData = ref({
                "Starlux": { name: "星宇航空" },
                "EVA": { name: "長榮航空" },
                "China Airlines": { name: "中華航空" },
                "Cathay Pacific": { name: "國泰航空" },
                "JAL": { name: "日本航空" },
                "ANA": { name: "全日本空輸" },
                "Peach": { name: "樂桃航空" },
                "Scoot": { name: "酷航" },
                "Tigerair": { name: "台灣虎航" },
                "AirAsia": { name: "亞洲航空" },
                "Jetstar": { name: "捷星航空" },
                "VietJet": { name: "越捷航空" },
                "HK Express": { name: "香港快運" },
                "Jeju Air": { name: "濟州航空" },
                "T'way Air": { name: "德威航空" },
                "Jin Air": { name: "真航空" },
                "Cebu Pacific": { name: "宿霧太平洋航空" },
                "Philippine Airlines": { name: "菲律賓航空" },
                "Singapore Airlines": { name: "新加坡航空" },
                "Malaysia Airlines": { name: "馬來西亞航空" },
                "Thai Airways": { name: "泰國航空" },
                "Korean Air": { name: "大韓航空" },
                "Asiana": { name: "韓亞航空" },
                "China Eastern": { name: "中國東方航空" },
                "Xiamen Air": { name: "廈門航空" },
                "Garuda Indonesia": { name: "印尼鷹航" },
                "Royal Brunei": { name: "汶萊皇家航空" },
                "Emirates": { name: "阿聯酋航空" },
                "Etihad": { name: "阿提哈德航空" },
                "Qatar Airways": { name: "卡達航空" },
                "Turkish Airlines": { name: "土耳其航空" },
                "Saudia": { name: "沙烏地航空" },
                "Kuwait Airways": { name: "科威特航空" },
                "Oman Air": { name: "阿曼航空" },
                "El Al": { name: "以色列航空" },
                "United": { name: "聯合航空" },
                "Delta": { name: "達美航空" },
                "American Airlines": { name: "美國航空" },
                "Air Canada": { name: "加拿大航空" },
                "Alaska Airlines": { name: "阿拉斯加航空" },
                "Southwest": { name: "西南航空" },
                "JetBlue": { name: "捷藍航空" },
                "Spirit": { name: "精神航空" },
                "Frontier": { name: "邊疆航空" },
                "LATAM": { name: "智利南美航空" },
                "Aeromexico": { name: "墨西哥航空" },
                "Copa Airlines": { name: "巴拿馬航空" },
                "Avianca": { name: "哥倫比亞航空" },
                "WestJet": { name: "西捷航空" },
                "Air Transat": { name: "越洋航空" },
                "Lufthansa": { name: "漢莎航空" },
                "British Airways": { name: "英國航空" },
                "Air France": { name: "法國航空" },
                "KLM": { name: "荷蘭皇家航空" },
                "Swiss": { name: "瑞士國際航空" },
                "Austrian Airlines": { name: "奧地利航空" },
                "Brussels Airlines": { name: "布魯塞爾航空" },
                "SAS": { name: "北歐航空" },
                "Finnair": { name: "芬蘭航空" },
                "Norwegian": { name: "挪威航空" },
                "Icelandair": { name: "冰島航空" },
                "Ryanair": { name: "瑞安航空" },
                "EasyJet": { name: "易捷航空" },
                "Wizz Air": { name: "威茲航空" },
                "Virgin Atlantic": { name: "維珍航空" },
                "TAP Portugal": { name: "葡萄牙航空" },
                "Iberia": { name: "伊比利航空" },
                "ITA Airways": { name: "義大利航空" },
                "LOT Polish": { name: "波蘭航空" },
                "Aer Lingus": { name: "愛爾蘭航空" },
                "Qantas": { name: "澳洲航空" },
                "Air New Zealand": { name: "紐西蘭航空" },
                "Ethiopian Airlines": { name: "衣索比亞航空" },
                "EgyptAir": { name: "埃及航空" },
                "Royal Air Maroc": { name: "摩洛哥皇家航空" },
                "South African Airways": { name: "南非航空" },
                "Air India": { name: "印度航空" },
                "IndiGo": { name: "靛藍航空" },
                "SriLankan Airlines": { name: "斯里蘭卡航空" }
            });

            const tripData = ref({ 
                title: "2025年大阪京都之旅", 
                days: [
                    { date: "2025/12/09", weekday: "Tuesday", title: "抵達大阪", desc: "關西機場 -> 大阪市區", tips: "Rapi:t 車票" },
                    { date: "2025/12/10", weekday: "Wednesday", title: "京丹後市一日遊", desc: "海上列車/天橋立/智恩寺/伊根舟屋", tips: "" },
                    { date: "2025/12/11", weekday: "Thursday", title: "京都神社之旅", desc: "參觀不同特色的神社 ⛩️", tips: "" },
                    { date: "2025/12/12", weekday: "Friday", title: "賞楓之旅", desc: "京都賞楓最佳景點 🍁", tips: "" },
                    { date: "2025/12/13", weekday: "Saturday", title: "嵐山 / 返程", desc: "嵐山小火車 -> 機場", tips: "" }
                ]
            });

            const itinerary = ref([]);
            const flights = ref([]);
            const hotels = ref([]);
            const expenses = ref([]);
            const packingList = ref([{id:'pack_1', text:"護照", checked:false}]);
            const subwayMaps = ref([]);
            const trainTickets = ref([]);
            const collectedTickets = ref([]);

            const form = ref({});
            const newTagText = ref("");
            const newTagColor = ref("gray");
            
            const closeModal = () => {
                showModal.value = false;
            };

            // --- ★★★ 新增功能 1：下拉刷新邏輯 (Pull to Refresh) ★★★ ---
            const pullStart = ref(0);
            const isPulling = ref(false);

            const handleTouchStart = (e) => {
                const mainEl = document.getElementById('mainContent');
                if (mainEl.scrollTop === 0) {
                    pullStart.value = e.touches[0].clientY;
                    isPulling.value = true;
                }
            };

            const handleTouchMove = (e) => {
                if (!isPulling.value) return;
                const touchY = e.touches[0].clientY;
                const pullDistance = touchY - pullStart.value;
                const loader = document.getElementById('pull-refresh-loader');

                // 只有在頂部且往下拉時才觸發
                if (pullDistance > 0 && document.getElementById('mainContent').scrollTop <= 0) {
                    // 增加阻尼感，不要拉太快
                    const move = Math.min(pullDistance * 0.4, 80); 
                    loader.style.height = `${move}px`;
                    loader.style.opacity = Math.min(move / 50, 1);
                }
            };

            const handleTouchEnd = (e) => {
                if (!isPulling.value) return;
                isPulling.value = false;
                const loader = document.getElementById('pull-refresh-loader');
                
                // 如果拉動超過 60px，就觸發刷新
                if (parseInt(loader.style.height) > 60) {
                    loader.style.height = '60px'; // 停留在顯示狀態
                    setTimeout(() => {
                        window.location.reload(); // 重新整理頁面
                    }, 500);
                } else {
                    // 拉不夠長，彈回去
                    loader.style.height = '0px';
                    loader.style.opacity = '0';
                }
            };

// 1. 新增控制確認視窗的變數
            const showDeleteConfirm = ref(false);

            // 2. 按下「刪除」按鈕時觸發 (只開視窗，不刪除)
            const killItem = () => {
                showDeleteConfirm.value = true;
            };

            // 3. 按下「確認刪除」時觸發 (真正的劊子手)
            const executeDelete = () => {
                // 獲取 ID (邏輯同上一次成功版本)
                const targetId = form.value.id || editingId.value || (modalType.value === 'daySettings' ? 'day_delete' : null);
                const type = modalType.value;

                if (!targetId && type !== 'daySettings') {
                    // 如果這時候還找不到 ID，默默關閉就好，不跳原生 alert
                    showDeleteConfirm.value = false;
                    return;
                }

                // --- 開始執行刪除 (邏輯同上一次成功版本) ---
                const strId = String(targetId);
                let deleted = false;

                if (type === 'daySettings') {
                    removeDay(selectedDayIndex.value);
                    deleted = true;
                } 
                else if (type.includes('activity')) {
                    itinerary.value = itinerary.value.filter(i => String(i.id) !== strId);
                    deleted = true;
                }
                else if (type.includes('flight')) {
                    flights.value = flights.value.filter(i => String(i.id) !== strId);
                    collectedTickets.value = collectedTickets.value.filter(i => String(i.id) !== strId);
                    deleted = true;
                }
                else if (type === 'hotel') {
                    hotels.value = hotels.value.filter(i => String(i.id) !== strId);
                    deleted = true;
                }
                else if (type === 'expense') {
                    expenses.value = expenses.value.filter(i => String(i.id) !== strId);
                    deleted = true;
                }
                else if (type.includes('memory') || type === 'checkin') {
                    const idx = itinerary.value.findIndex(i => String(i.id) === strId);
                    if(idx !== -1) {
                        itinerary.value[idx].checkedIn = false;
                        itinerary.value[idx].checkInPhoto = null;
                        itinerary.value[idx].checkInThoughts = '';
                    }
                    deleted = true;
                }
                else {
                    // 通用刪除
                    packingList.value = packingList.value.filter(i => String(i.id) !== strId);
                    subwayMaps.value = subwayMaps.value.filter(i => String(i.id) !== strId);
                    jpPhrases.value = jpPhrases.value.filter(p => String(p.id) !== strId);
                    trainTickets.value = trainTickets.value.filter(i => String(i.id) !== strId);
                    collectedTickets.value = collectedTickets.value.filter(i => String(i.id) !== strId);
                    deleted = true;
                }

                // 存檔並關閉所有視窗
                saveToLocal();
                showDeleteConfirm.value = false; // 關閉確認窗
                closeModal(); // 關閉編輯窗
            };

            const currentDayData = computed(() => tripData.value?.days[selectedDayIndex.value] || { date: '2025/12/09', weekday: '-', title: 'Loading...', desc: '' });
            
            // --- UPDATED: Remove auto-sort by time to allow manual reordering ---
            const currentDayItinerary = computed(() => itinerary.value.filter(item => item.dayIndex === selectedDayIndex.value));
            
            // --- UPDATED: Remove auto-sort for manually ordered memories ---
            const memories = computed(() => {
                return itinerary.value.filter(i => i.checkedIn);
            });
            
            const totalExpenseTWD = computed(() => expenses.value.reduce((acc, cur) => acc + (cur.amount * (currencyRates.value[cur.currency] || 0)), 0));

            const filteredCurrencies = computed(() => {
                const term = currencySearch.value.toLowerCase();
                return allCurrencies.value.filter(c => c.code.toLowerCase().includes(term) || c.name.includes(term));
            });
            
            const modalFilteredCurrencies = computed(() => {
                const term = modalCurrencySearch.value.toLowerCase();
                return allCurrencies.value.filter(c => c.code.toLowerCase().includes(term) || c.name.includes(term));
            });
            
            const groupedTickets = computed(() => {
                const groups = { flights: [], trains: [], spots: [] };
                if (!collectedTickets.value) return groups;
                collectedTickets.value.forEach(t => {
                    if(t.type === 'flight') groups.flights.push(t);
                    else if(t.type === 'train') groups.trains.push(t);
                    else if(t.type === 'spot') groups.spots.push(t);
                });
                // Remove auto-sort to support manual reordering
                return groups;
            });

            // ... (Helper functions like getTrainClass, initMap, updateMapMarkers...) ...
            const getTrainClass = (type) => {
                if (type === 'Shinkansen') return 'ticket-shinkansen';
                if (type === 'Sightseeing') return 'ticket-sightseeing';
                if (type === 'CableCar') return 'ticket-cable';
                return 'ticket-haruka';
            };

            const initMap = () => {
                const container = document.getElementById('map-container'); 
                if(!container || container.clientHeight === 0) return;
                
                if (mapInstance.value) {
                    mapInstance.value.remove();
                    mapInstance.value = null;
                }
                
                mapInstance.value = L.map('map-container', { zoomControl: false }).setView([34.69, 135.50], 13);
                L.tileLayer('https://mt0.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, attribution: '&copy; Google Maps' }).addTo(mapInstance.value);
                markersLayer.value = L.layerGroup().addTo(mapInstance.value);
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                         const {latitude, longitude} = pos.coords;
                         if(mapInstance.value) {
                            L.circleMarker([latitude, longitude], { color: '#3b82f6', fillColor: '#60a5fa', fillOpacity: 0.8, radius: 8 }).addTo(mapInstance.value).bindPopup("You are here");
                         }
                    }, err => console.log(err));
                }
                
                updateMapMarkers();
            };

            const updateMapMarkers = () => {
                if(!mapInstance.value || !markersLayer.value) return;
                markersLayer.value.clearLayers();
                const points = [];
                const extractCoords = (url) => {
                     if (!url) return null;
                     let match = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                     if (match) return [parseFloat(match[1]), parseFloat(match[2])];
                     match = url.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
                     if (match) return [parseFloat(match[1]), parseFloat(match[2])];
                     match = url.match(/[?&]q=(-?\d+\.\d+),(-?\d+\.\d+)/);
                     if (match) return [parseFloat(match[1]), parseFloat(match[2])];
                     return null;
                };

                currentDayItinerary.value.forEach(item => {
                    let coords = null;
                    if (item.location || item.mapUrl) {
                        coords = extractCoords(item.mapUrl || item.location); 
                        if (!coords && item.location) {
                            const db = { 
                                "Kansai": [34.43, 135.23], "Dotonbori": [34.6687, 135.5013], "USJ": [34.6654, 135.4323], 
                                "Kyoto": [34.9858, 135.7588], "Osaka Castle": [34.6873, 135.5262], "Arashiyama": [35.0094, 135.6668], 
                                "Kiyomizu": [34.9948, 135.7850], "Fushimi Inari": [34.9671, 135.7726], "Kinkakuji": [35.0394, 135.7292],
                                "Nara": [34.6851, 135.8048], "Umeda": [34.7025, 135.4960], "Tsutenkaku": [34.6525, 135.5063],
                                "Ine": [35.6705, 135.2917], "Amanohashidate": [35.5701, 135.1917]
                            };
                            for(const k in db) if(item.location.toLowerCase().includes(k.toLowerCase())) coords = db[k];
                        }
                    }
                    if(coords) points.push({ title: item.title, coords });
                });
                points.forEach(p => L.marker(p.coords).addTo(markersLayer.value).bindPopup(p.title));
                if(points.length > 0) {
                     const bounds = L.latLngBounds(points.map(p => p.coords));
                     mapInstance.value.fitBounds(bounds, { padding: [50, 50] });
                }
            };
            
            watch(currentDayItinerary, () => { if(currentTab.value === 'itinerary') nextTick(updateMapMarkers); }, { deep: true });
            watch(currentTab, (newTab) => { if(newTab === 'itinerary') nextTick(initMap); });
            watch(selectedDayIndex, () => { if(currentTab.value === 'itinerary') nextTick(initMap); });

            const fetchRates = async () => {
                try {
                    const res = await fetch('https://open.er-api.com/v6/latest/TWD');
                    const data = await res.json();
                    if(data && data.rates) {
                        const newRates = {}; const list = [];
                        Object.keys(data.rates).sort().forEach(code => {
                            newRates[code] = 1 / data.rates[code];
                            list.push({ code, name: commonCurrencies[code] || code });
                        });
                        newRates["TWD"] = 1;
                        currencyRates.value = newRates;
                        allCurrencies.value = list;
                    }
                } catch(err) { console.log("Rate fetch failed"); }
            };

const getAirlineLogo = (name) => {
                 if(!name) return null; 
                 const n = name.toLowerCase();
                 // Asia
                 // Fix: Jetstar logo logic was incorrect due to 'star' matching Starlux
                 if(n.includes('starlux') || n.includes('星宇')) return 'https://logo.clearbit.com/starlux-airlines.com';
                 if(n.includes('eva') || n.includes('長榮')) return 'https://logo.clearbit.com/evaair.com';
                 if(n.includes('china') || n.includes('華航')) return 'https://logo.clearbit.com/china-airlines.com';
                 if(n.includes('peach') || n.includes('樂桃')) return 'https://logo.clearbit.com/flypeach.com';
                 if(n.includes('scoot') || n.includes('酷航')) return 'https://logo.clearbit.com/flyscoot.com';
                 if(n.includes('tiger') || n.includes('虎航')) return 'https://logo.clearbit.com/tigerairtw.com';
                 if(n.includes('airasia') || n.includes('亞洲')) return 'https://logo.clearbit.com/airasia.com';
                 if(n.includes('jetstar') || n.includes('捷星')) return 'https://logo.clearbit.com/jetstar.com';
                 if(n.includes('vietjet') || n.includes('越捷')) return 'https://logo.clearbit.com/vietjetair.com';
                 if(n.includes('korean') || n.includes('大韓')) return 'https://logo.clearbit.com/koreanair.com';
                 if(n.includes('asiana') || n.includes('韓亞')) return 'https://logo.clearbit.com/flyasiana.com';
                 if(n.includes('thai') || n.includes('泰國')) return 'https://logo.clearbit.com/thaiairways.com';
                 if(n.includes('singapore') || n.includes('新加坡')) return 'https://logo.clearbit.com/singaporeair.com';
                 if(n.includes('emirates') || n.includes('阿聯酋')) return 'https://logo.clearbit.com/emirates.com';
                 if(n.includes('etihad') || n.includes('阿堤哈德')) return 'https://logo.clearbit.com/etihad.com';
                 if(n.includes('qatar') || n.includes('卡達')) return 'https://logo.clearbit.com/qatarairways.com';
                 if(n.includes('eastern') || n.includes('中國東方')) return 'https://logo.clearbit.com/ceair.com';
                 if(n.includes('xiamen') || n.includes('廈門')) return 'https://logo.clearbit.com/xiamenair.com';
                 if(n.includes('cathay') || n.includes('國泰')) return 'https://logo.clearbit.com/cathaypacific.com';
                 if(n.includes('ana') || n.includes('全日本')) return 'https://logo.clearbit.com/ana.co.jp';
                 if(n.includes('jal') || n.includes('日本')) return 'https://logo.clearbit.com/jal.com';
                 if(n.includes('cebu') || n.includes('宿霧太平洋')) return 'https://logo.clearbit.com/cebupacificair.com';
                 if(n.includes('hk express') || n.includes('香港快捷')) return 'https://logo.clearbit.com/hkexpress.com';
                 if(n.includes('jeju') || n.includes('濟州')) return 'https://logo.clearbit.com/jejuair.net';
                 if(n.includes('tway') || n.includes('德威')) return 'https://logo.clearbit.com/twayair.com';
                 if(n.includes('jin') || n.includes('真')) return 'https://logo.clearbit.com/jinair.com';
                 if(n.includes('garuda') || n.includes('印尼')) return 'https://logo.clearbit.com/garuda-indonesia.com';
                 if(n.includes('malaysia') || n.includes('馬來西亞')) return 'https://logo.clearbit.com/malaysiaairlines.com';
                 if(n.includes('philippine') || n.includes('菲律賓')) return 'https://logo.clearbit.com/philippineairlines.com';
                 if(n.includes('indigo') || n.includes('靛藍')) return 'https://logo.clearbit.com/goindigo.in';
                 if(n.includes('air india') || n.includes('印度')) return 'https://logo.clearbit.com/airindia.in';
                 if(n.includes('srilankan') || n.includes('斯里蘭卡')) return 'https://logo.clearbit.com/srilankan.com';
                 if(n.includes('brunei') || n.includes('汶萊')) return 'https://logo.clearbit.com/flyroyalbrunei.com';

                 // Americas
                 if(n.includes('latam') || n.includes('智利南美')) return 'https://logo.clearbit.com/latam.com';
                 if(n.includes('aeromexico') || n.includes('墨西哥')) return 'https://logo.clearbit.com/aeromexico.com';
                 if(n.includes('jetblue') || n.includes('捷藍')) return 'https://logo.clearbit.com/jetblue.com';
                 if(n.includes('spirit') || n.includes('精神')) return 'https://logo.clearbit.com/spirit.com';
                 if(n.includes('frontier') || n.includes('邊疆')) return 'https://logo.clearbit.com/flyfrontier.com';
                 if(n.includes('alaska') || n.includes('阿拉斯加')) return 'https://logo.clearbit.com/alaskaair.com';
                 if(n.includes('southwest') || n.includes('西南')) return 'https://logo.clearbit.com/southwest.com';
                 if(n.includes('copa') || n.includes('巴拿馬')) return 'https://logo.clearbit.com/copaair.com';
                 if(n.includes('avianca') || n.includes('哥倫比亞')) return 'https://logo.clearbit.com/avianca.com';
                 if(n.includes('westjet') || n.includes('西捷')) return 'https://logo.clearbit.com/westjet.com';
                 if(n.includes('transat') || n.includes('越洋')) return 'https://logo.clearbit.com/airtransat.com';
                 if(n.includes('american') || n.includes('aa') || n.includes('美國')) return 'https://logo.clearbit.com/aa.com';
                 if(n.includes('delta') || n.includes('達美')) return 'https://logo.clearbit.com/delta.com';
                 if(n.includes('united') || n.includes('聯合')) return 'https://logo.clearbit.com/united.com';
                 if(n.includes('canada') || n.includes('加拿大')) return 'https://logo.clearbit.com/aircanada.com';

                 // Europe
                 if(n.includes('swiss') || n.includes('瑞士')) return 'https://logo.clearbit.com/swiss.com';
                 if(n.includes('virgin') || n.includes('維珍')) return 'https://logo.clearbit.com/virginatlantic.com';
                 if(n.includes('ryanair') || n.includes('瑞安')) return 'https://logo.clearbit.com/ryanair.com';
                 if(n.includes('easyjet') || n.includes('易捷')) return 'https://logo.clearbit.com/easyjet.com';
                 if(n.includes('lot') || n.includes('波蘭')) return 'https://logo.clearbit.com/lot.com';
                 if(n.includes('lingus') || n.includes('愛爾蘭')) return 'https://logo.clearbit.com/aerlingus.com';
                 if(n.includes('austrian') || n.includes('奧地利')) return 'https://logo.clearbit.com/austrian.com';
                 if(n.includes('brussels') || n.includes('布魯塞爾')) return 'https://logo.clearbit.com/brusselsairlines.com';
                 if(n.includes('wizz') || n.includes('茲威') || n.includes('威茲')) return 'https://logo.clearbit.com/wizzair.com';
                 if(n.includes('sas') || n.includes('scandinavian') || n.includes('北歐')) return 'https://logo.clearbit.com/flysas.com';
                 if(n.includes('lufthansa') || n.includes('漢莎')) return 'https://logo.clearbit.com/lufthansa.com';
                 if(n.includes('british') || n.includes('英國')) return 'https://logo.clearbit.com/ba.com';
                 if(n.includes('france') || n.includes('法國')) return 'https://logo.clearbit.com/airfrance.com';
                 if(n.includes('klm') || n.includes('荷蘭皇家')) return 'https://logo.clearbit.com/klm.com';
                 if(n.includes('turkish') || n.includes('土耳其')) return 'https://logo.clearbit.com/turkishairlines.com';
                 if(n.includes('finnair') || n.includes('芬蘭')) return 'https://logo.clearbit.com/finnair.com';
                 if(n.includes('icelandair') || n.includes('冰島')) return 'https://logo.clearbit.com/icelandair.com';
                 if(n.includes('norwegian') || n.includes('挪威')) return 'https://logo.clearbit.com/norwegian.com';
                 if(n.includes('tap') || n.includes('葡萄牙')) return 'https://logo.clearbit.com/flytap.com';
                 if(n.includes('iberia') || n.includes('依比利')) return 'https://logo.clearbit.com/iberia.com';
                 if(n.includes('ita') || n.includes('義大利')) return 'https://logo.clearbit.com/itaspa.com';

                 // ME/Africa/Oceania
                 if(n.includes('saudia') || n.includes('沙烏地')) return 'https://logo.clearbit.com/saudia.com';
                 if(n.includes('kuwait') || n.includes('科威特')) return 'https://logo.clearbit.com/kuwaitairways.com';
                 if(n.includes('oman') || n.includes('阿曼')) return 'https://logo.clearbit.com/omanair.com';
                 if(n.includes('el al') || n.includes('以色列')) return 'https://logo.clearbit.com/elal.com';
                 if(n.includes('ethiopian') || n.includes('衣索比亞')) return 'https://logo.clearbit.com/ethiopianairlines.com';
                 if(n.includes('egypt') || n.includes('埃及')) return 'https://logo.clearbit.com/egyptair.com';
                 if(n.includes('moroc') || n.includes('摩洛哥')) return 'https://logo.clearbit.com/royalairmaroc.com';
                 if(n.includes('south african') || n.includes('南非')) return 'https://logo.clearbit.com/flysaa.com';

                 return `https://logo.clearbit.com/${name.replace(/[^\x00-\x7F]/g, "").replace(/\s+/g,'').trim()}.com`;
            };


            const getAirlineStyle = (name, flightClass) => {
                const n = (name || "").toLowerCase();
                let colors = ['#f8fafc', '#f1f5f9', '#94a3b8']; 
                let isStarlux = false;

if (n.includes('starlux') || n.includes('星宇')) { isStarlux = true; colors = ['#f4f0e6', '#f4f0e6', '#bfa588']; }
                else if (n.includes('eva') || n.includes('長榮')) colors = ['#006400', '#144914', '#eab308'];
                else if (n.includes('china') || n.includes('華航')) colors = ['#5b2c6f', '#4a235a', '#f472b6'];
                else if (n.includes('cathay') || n.includes('國泰')) colors = ['#006b70', '#004d50', '#2dd4bf'];
                else if (n.includes('jal') || n.includes('日本')) colors = ['#ffffff', '#f8fafc', '#dc2626'];
                else if (n.includes('ana') || n.includes('全日本')) colors = ['#ffffff', '#f0f9ff', '#0284c7'];
                else if (n.includes('peach') || n.includes('樂桃')) colors = ['#fdf2f8', '#fce7f3', '#db2777'];
                else if (n.includes('scoot') || n.includes('酷航')) colors = ['#fffbeb', '#fef3c7', '#f59e0b'];
                else if (n.includes('airasia') || n.includes('亞洲')) colors = ['#fef2f2', '#fee2e2', '#ef4444'];
                else if (n.includes('singapore') || n.includes('新加坡')) colors = ['#1e3a8a', '#172554', '#f59e0b'];
                else if (n.includes('emirates') || n.includes('阿聯酋')) colors = ['#b91c1c', '#991b1b', '#d4b165'];
                else if (n.includes('etihad') || n.includes('阿堤哈德')) colors = ['#fdf4ff', '#fae8ff', '#d4b165'];
                else if (n.includes('qatar') || n.includes('卡達')) colors = ['#581c87', '#3b0764', '#e879f9'];
                else if (n.includes('eastern') || n.includes('中國東方')) colors = ['#1e3a8a', '#1e40af', '#ef4444'];
                else if (n.includes('xiamen') || n.includes('廈門')) colors = ['#0ea5e9', '#0284c7', '#ffffff'];
                else if (n.includes('jetstar') || n.includes('捷星')) colors = ['#F37335', '#FDC830', '#ffffff'];
                else if (n.includes('vietjet') || n.includes('越捷')) colors = ['#ef4444', '#dc2626', '#fbbf24'];
                else if (n.includes('korean') || n.includes('大韓')) colors = ['#bfdbfe', '#93c5fd', '#1e40af'];
                else if (n.includes('asiana') || n.includes('韓亞')) colors = ['#f5f5f4', '#e7e5e4', '#dc2626'];
                else if (n.includes('thai') || n.includes('泰國')) colors = ['#4338ca', '#3730a3', '#a855f7'];
                else if (n.includes('tiger') || n.includes('虎航')) colors = ['#fff7ed', '#ffedd5', '#f97316'];
                else if (n.includes('cebu') || n.includes('宿霧太平洋')) colors = ['#fef9c3', '#fde047', '#1e40af'];
                else if (n.includes('hk express') || n.includes('香港快運')) colors = ['#6b21a8', '#581c87', '#dc2626'];
                else if (n.includes('jeju') || n.includes('濟州')) colors = ['#f97316', '#ea580c', '#ffffff'];
                else if (n.includes('tway') || n.includes('德威')) colors = ['#dc2626', '#b91c1c', '#ffffff'];
                else if (n.includes('jin') || n.includes('真')) colors = ['#84cc16', '#65a30d', '#ec4899'];
                else if (n.includes('garuda') || n.includes('印尼')) colors = ['#1e3a8a', '#172554', '#0ea5e9'];
                else if (n.includes('malaysia') || n.includes('馬來西亞')) colors = ['#1e40af', '#1e3a8a', '#dc2626'];
                else if (n.includes('philippine') || n.includes('菲律賓')) colors = ['#ffffff', '#f1f5f9', '#1d4ed8'];
                else if (n.includes('indigo') || n.includes('靛藍')) colors = ['#1e3a8a', '#172554', '#ffffff'];
                else if (n.includes('air india') || n.includes('印度')) colors = ['#b91c1c', '#991b1b', '#f59e0b'];
                else if (n.includes('srilankan') || n.includes('斯里蘭卡')) colors = ['#0f766e', '#0d9488', '#fbbf24'];
                else if (n.includes('brunei') || n.includes('汶萊')) colors = ['#facc15', '#eab308', '#000000'];
                
                // Americas
                else if (n.includes('latam') || n.includes('智利南美')) colors = ['#1e1b4b', '#312e81', '#ef4444'];
                else if (n.includes('aeromexico') || n.includes('墨西哥')) colors = ['#1e3a8a', '#172554', '#ef4444'];
                else if (n.includes('jetblue') || n.includes('捷藍')) colors = ['#1e40af', '#1e3a8a', '#fbbf24'];
                else if (n.includes('spirit') || n.includes('精神')) colors = ['#fef08a', '#fde047', '#000000'];
                else if (n.includes('frontier') || n.includes('邊疆')) colors = ['#14532d', '#166534', '#ffffff'];
                else if (n.includes('alaska') || n.includes('阿拉斯加')) colors = ['#0f172a', '#1e293b', '#84cc16'];
                else if (n.includes('southwest') || n.includes('西南')) colors = ['#1d4ed8', '#1e40af', '#facc15'];
                else if (n.includes('copa') || n.includes('巴拿馬')) colors = ['#1e3a8a', '#1e40af', '#fbbf24'];
                else if (n.includes('avianca') || n.includes('哥倫比亞')) colors = ['#dc2626', '#b91c1c', '#ffffff'];
                else if (n.includes('westjet') || n.includes('西捷')) colors = ['#0f766e', '#0d9488', '#ffffff'];
                else if (n.includes('transat') || n.includes('越洋')) colors = ['#1e3a8a', '#172554', '#38bdf8'];
                else if (n.includes('american') || n.includes('aa') || n.includes('美國')) colors = ['#f8fafc', '#f1f5f9', '#0ea5e9'];
                else if (n.includes('delta') || n.includes('達美')) colors = ['#1e3a8a', '#172554', '#ef4444'];
                else if (n.includes('united') || n.includes('聯合')) colors = ['#1e40af', '#1e3a8a', '#fbbf24'];
                else if (n.includes('canada') || n.includes('加拿大')) colors = ['#000000', '#e60000', '#ffffff'];

                // Europe
                else if (n.includes('swiss') || n.includes('瑞士')) colors = ['#ef4444', '#dc2626', '#ffffff'];
                else if (n.includes('virgin') || n.includes('維珍')) colors = ['#b91c1c', '#991b1b', '#ffffff'];
                else if (n.includes('ryanair') || n.includes('瑞安')) colors = ['#1e3a8a', '#172554', '#facc15'];
                else if (n.includes('easyjet') || n.includes('易捷')) colors = ['#f97316', '#ea580c', '#ffffff'];
                else if (n.includes('lot') || n.includes('波蘭')) colors = ['#1e3a8a', '#172554', '#ffffff'];
                else if (n.includes('lingus') || n.includes('愛爾蘭')) colors = ['#15803d', '#166534', '#ffffff'];
                else if (n.includes('austrian') || n.includes('奧地利')) colors = ['#dc2626', '#b91c1c', '#ffffff'];
                else if (n.includes('brussels') || n.includes('布魯塞爾')) colors = ['#1e3a8a', '#1e40af', '#ef4444'];
                else if (n.includes('wizz') || n.includes('茲威') || n.includes('威茲')) colors = ['#be185d', '#9d174d', '#ffffff'];
                else if (n.includes('sas') || n.includes('scandinavian') || n.includes('北歐')) colors = ['#1e3a8a', '#1e40af', '#ffffff'];
                else if (n.includes('lufthansa') || n.includes('漢莎')) colors = ['#1e3a8a', '#172554', '#facc15'];
                else if (n.includes('british') || n.includes('英國')) colors = ['#ffffff', '#f1f5f9', '#dc2626'];
                else if (n.includes('france') || n.includes('法國')) colors = ['#ffffff', '#f1f5f9', '#1d4ed8'];
                else if (n.includes('klm') || n.includes('荷蘭皇家')) colors = ['#e0f2fe', '#bae6fd', '#0ea5e9'];
                else if (n.includes('turkish') || n.includes('土耳其')) colors = ['#ef4444', '#dc2626', '#ffffff'];
                else if (n.includes('finnair') || n.includes('芬蘭')) colors = ['#ffffff', '#f0f9ff', '#0b2161'];
                else if (n.includes('icelandair') || n.includes('冰島')) colors = ['#1e3a8a', '#172554', '#fbbf24'];
                else if (n.includes('norwegian') || n.includes('挪威')) colors = ['#ffffff', '#fee2e2', '#dc2626'];
                else if (n.includes('tap') || n.includes('葡萄牙')) colors = ['#f0fdf4', '#dcfce7', '#15803d'];
                else if (n.includes('iberia') || n.includes('依比利')) colors = ['#fef2f2', '#fee2e2', '#b91c1c'];
                else if (n.includes('ita') || n.includes('義大利')) colors = ['#f0f9ff', '#e0f2fe', '#0ea5e9'];

                // ME/Africa/Oceania
                else if (n.includes('saudia') || n.includes('沙烏地')) colors = ['#f0fdf4', '#dcfce7', '#15803d'];
                else if (n.includes('kuwait') || n.includes('科威特')) colors = ['#1e3a8a', '#1e40af', '#ffffff'];
                else if (n.includes('oman') || n.includes('阿曼')) colors = ['#fefce8', '#fef9c3', '#ca8a04'];
                else if (n.includes('el al') || n.includes('以色列')) colors = ['#eff6ff', '#dbeafe', '#2563eb'];
                else if (n.includes('ethiopian') || n.includes('衣索比亞')) colors = ['#f0fdf4', '#dcfce7', '#16a34a'];
                else if (n.includes('egypt') || n.includes('埃及')) colors = ['#1e3a8a', '#1e40af', '#fbbf24'];
                else if (n.includes('moroc') || n.includes('摩洛哥')) colors = ['#fef2f2', '#fee2e2', '#b91c1c'];
                else if (n.includes('south african') || n.includes('南非')) colors = ['#fff7ed', '#ffedd5', '#ea580c'];
                else if (n.includes('qantas') || n.includes('澳洲')) colors = ['#ffffff', '#f1f5f9', '#ef4444'];
                else if (n.includes('zealand') || n.includes('紐西蘭')) colors = ['#000000', '#1c1917', '#ffffff'];
                
                if (n.includes('starlux') || n.includes('星宇')) { isStarlux = true; colors = ['#f4f0e6', '#f4f0e6', '#bfa588']; }
                if (isStarlux) {
                    return { container: { backgroundColor: '#f4f0e6', border: '1px solid #e5e5e5' }, header: { backgroundColor: 'white', borderBottom: '2px solid #bfa588', color: '#bfa588' }, headerText: '#bfa588', text: '#5c5c5c' };
                }
                const isDark = (colors[0].charAt(1) < '9' && colors[0] !== '#ffffff');
                return {
                    container: { background: `linear-gradient(135deg, ${colors[0]}, ${colors[1]})` },
                    header: { borderBottom: `1px solid rgba(255,255,255,0.2)` },
                    headerText: isDark ? 'white' : '#1e293b',
                    text: isDark ? 'white' : '#334155'
                };
            };

            const getTagStyle = (tag) => {
                if (tag && typeof tag === 'object' && tag.color) {
                    const style = getTransportColor(tag.color);
                    return { backgroundColor: style.bg, color: style.text, borderColor: style.border };
                }
                const text = (typeof tag === 'object' && tag.text) ? tag.text : String(tag);
                let hash = 0; for (let i = 0; i < text.length; i++) hash = text.charCodeAt(i) + ((hash << 5) - hash);
                return { backgroundColor: `hsl(${Math.abs(hash) % 360}, 70%, 90%)`, color: `hsl(${Math.abs(hash) % 360}, 70%, 30%)` };
            };
            
            const getTypeColor = (type) => {
                const colors = { food: '#eab308', spot: '#22c55e', shopping: '#f97316', fun: '#ef4444', temple: '#3bc7f6', nature: '#3e43cf', citytour: '#a855f7' };
                return colors[type] || '#64748b';
            };

            const itineraryTypes = ref([
                { value: 'spot', label: '觀光景點', icon: 'fa-solid fa-camera-retro' },
                { value: 'food', label: '美食餐廳', icon: 'fa-solid fa-utensils' },
                { value: 'shopping', label: '逛街購物', icon: 'fa-solid fa-bag-shopping' },
                { value: 'temple', label: '寺廟神社', icon: 'fa-solid fa-torii-gate' },
                { value: 'fun', label: '休閒娛樂', icon: 'fa-solid fa-ticket' },
                { value: 'citytour', label: '城市遊覽', icon: 'fa-solid fa-city' },
                { value: 'nature', label: '自然美景', icon: 'fa-solid fa-tree' }
            ]);

            const getTransportColor = (name) => {
                const colors = { red: {bg:'#fef2f2', border:'#fca5a5', text:'#b91c1c', textDark:'#7f1d1d'}, orange: {bg:'#ffedd5', border:'#fdba74', text:'#c2410c', textDark:'#7c2d12'}, yellow: {bg:'#fef9c3', border:'#fde047', text:'#a16207', textDark:'#713f12'}, green: {bg:'#dcfce7', border:'#86efac', text:'#15803d', textDark:'#14532d'}, blue: {bg:'#dbeafe', border:'#93c5fd', text:'#1d4ed8', textDark:'#1e3a8a'}, indigo: {bg:'#e0e7ff', border:'#a5b4fc', text:'#4338ca', textDark:'#312e81'}, purple: {bg:'#f3e8ff', border:'#d8b4fe', text:'#7e22ce', textDark:'#581c87'}, pink: {bg:'#fce7f3', border:'#f9a8d4', text:'#be185d', textDark:'#831843'}, brown: {bg:'#f5d0b5', border:'#d7a58c', text:'#78350f', textDark:'#451a03'}, gray: {bg:'#f1f5f9', border:'#cbd5e1', text:'#475569', textDark:'#0f172a'} };
                return colors[name] || colors.gray;
            };

            const getTypeIcon = (t) => { if(t==='food') return 'fa-solid fa-utensils'; if(t==='transport') return 'fa-solid fa-train-subway'; if(t==='shopping') return 'fa-solid fa-bag-shopping'; if(t==='spot') return 'fa-solid fa-camera'; if(t==='fun') return 'fa-solid fa-icons'; if(t==='citytour') return 'fa-solid fa-city'; if(t==='temple') return 'fa-solid fa-torii-gate'; if(t==='nature') return 'fa-brands fa-fort-awesome'; return 'fa-solid fa-location-dot'; };
            const getDayIcon = (i) => { const icons = ['fa-solid fa-plane-arrival', 'fa-solid fa-train-subway', 'fa-solid fa-torii-gate', 'fa-solid fa-leaf', 'fa-solid fa-plane-departure']; return icons[i] || 'fa-solid fa-calendar-day'; };
            
            const getWeatherCityForDay = (i) => {
                if (i === 0) return { name: '大阪 (Osaka)', key: 'osaka' };
                if (i === 1) return { name: '京丹後 (Kyotango)', key: 'kyotango' };
                return { name: '京都 (Kyoto)', key: 'kyoto' }; 
            };
            
            const getStampIcon = (t) => t.includes('寺')||t.includes('神')?'fa-solid fa-torii-gate':t.includes('城')?'fa-brands fa-fort-awesome':t.includes('船')||t.includes('舟')?'fa-solid fa-sailboat':t.includes('車')||t.includes('鐵')?'fa-solid fa-train-tram':'fa-solid fa-camera-retro';

            const weatherForecast5Days = computed(() => {
                const currentDay = tripData.value?.days[selectedDayIndex.value];
                if (!currentDay) return [];
                const parts = currentDay.date.split('/');
                let baseDate = new Date();
                if(parts.length === 3) { baseDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])); }
                
                const weatherProfiles = { 'osaka': { baseHigh: 12, baseLow: 5, conditions: ['fa-sun', 'fa-cloud-sun', 'fa-cloud', 'fa-sun'] }, 'kyotango': { baseHigh: 8, baseLow: 2, conditions: ['fa-cloud-rain', 'fa-snowflake', 'fa-wind', 'fa-cloud'] }, 'kyoto': { baseHigh: 10, baseLow: 2, conditions: ['fa-cloud-sun', 'fa-cloud', 'fa-cloud-rain', 'fa-sun'] } };
                const cityKey = getWeatherCityForDay(selectedDayIndex.value).key;
                const profile = weatherProfiles[cityKey] || weatherProfiles['osaka'];
                const forecast = [];
                
                for (let i = 0; i < 5; i++) {
                     const d = new Date(baseDate);
                     d.setDate(baseDate.getDate() + i);
                     const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                     const weekday = d.toLocaleDateString('en-US', { weekday: 'short' });
                     const pseudoRandom = (d.getDate()) % profile.conditions.length;
                     const conditionIcon = profile.conditions[pseudoRandom];
                     let colorClass = 'icon-cloud';
                     let rainChance = 20;
                     if(conditionIcon.includes('sun')) { colorClass = 'icon-sun'; rainChance = 10; }
                     if(conditionIcon.includes('rain')) { colorClass = 'icon-rain'; rainChance = 60; }
                     if(conditionIcon.includes('snow')) { colorClass = 'icon-snow'; rainChance = 80; }
                     if(conditionIcon.includes('wind')) { colorClass = 'icon-cloud'; rainChance = 40; }
                     const tempOffset = (d.getDate() % 3) - 1; 
                     const temp = profile.baseHigh + tempOffset;
                     forecast.push({ dateStr, weekday, temp, icon: `fa-solid ${conditionIcon}`, colorClass, rain: rainChance });
                }
                return forecast;
            });
            
            const openCheckInModal = (item) => {
                modalType.value = 'checkin';
                modalTitle.value = item.checkedIn ? '編輯打卡' : '景點打卡';
                isEditing.value = !!item.checkedIn;
                editingId.value = item.id;
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                form.value = {
                    id: item.id,
                    title: item.title,
                    checkInDate: item.checkInDate || item.visitDate || now.toISOString().split('T')[0],
                    checkInTime: item.checkInTime || currentTime,
                    checkInThoughts: item.checkInThoughts || '',
                    checkInNote: item.checkInNote || '',
                    checkInPhoto: item.checkInPhoto || null // Removed item.image fallback
                };
                showModal.value = true;
            };

            const toggleCheckIn = (item) => { openCheckInModal(item); };

            const viewMemory = (mem) => {
                modalType.value = 'memory_details';
                modalTitle.value = '美好的回憶';
                isEditing.value = false;
                editingId.value = mem.id;
                form.value = { ...mem };
                showModal.value = true;
            };

            const addDay = () => tripData.value.days.push({ date: 'New Date', weekday: 'Day', title: 'New Day', desc: '', tips:'' });
            
            // ... (openModal logic kept) ...
            const openModal = (type, data = null) => {
                if (data && type === 'activity') {
                    modalType.value = 'activity_details';
                    modalTitle.value = '行程詳細內容';
                } else if (data && type === 'flight') {
                    modalType.value = 'flight'; // Changed from flight_details to flight for direct editing
                    modalTitle.value = '編輯航班';
                } else {
                    modalType.value = type; 
                    if (type === 'daySettings') modalTitle.value = '編輯行程標題';
                    else if (type === 'activity') modalTitle.value = (!!data)?'編輯行程':'新增行程';
                    else if (type === 'flight') modalTitle.value = (!!data)?'編輯航班':'新增航班';
                    else if (type === 'checkin') modalTitle.value = '打卡回憶';
                    else if (type === 'trainInfo' || type === 'ticket_train') modalTitle.value = (!!data)?'編輯車票':'新增車票';
                    else if (type === 'hotel') modalTitle.value = (!!data)?'編輯住宿':'新增住宿';
                    else if (type === 'expense') modalTitle.value = '新增記帳';
                    else if (type === 'ticket_spot') modalTitle.value = '新增門票';
                    else if (type === 'ticket_flight') modalTitle.value = '機票資訊';
                    else if (type === 'subway') modalTitle.value = '新增地圖';
                    else if (type === 'phrase') modalTitle.value = '新增日語卡片';
                }
                
                isEditing.value = !!data; 
                editingId.value = data ? data.id : null; 
                showModal.value = true;
                newTagText.value = ""; 
                newTagColor.value = "gray";
                
                if (data) {
                    form.value = JSON.parse(JSON.stringify(data));
                } else {
                    const currentDayDate = tripData.value.days[selectedDayIndex.value]?.date || '2025/12/09';
                    if (type === 'activity') form.value = { type: 'spot', time: '10:00', title: '', location: '', mapUrl:'', note: '', businessHours: '', visitDate: currentDayDate, city: '', image: null, nextTransport: { mode: '', style: { color: 'gray' }, isBold: false, isItalic: false, useFrame: true, isRichText: true }, tags: [], externalLinks: [] };
                    else if (type === 'flight' || type === 'ticket_flight') form.value = { airline:'', number:'', class:'ECONOMY', depCode:'', arrCode:'', depTime:'', arrTime:'', date:'', depTerminal:'', arrTerminal:'', depCity:'', arrCity:'', passenger:'' };
                    else if (type === 'trainInfo' || type === 'ticket_train') form.value = { name:'', trainType:'Normal', date:'', depStation:'', depTime:'', arrStation:'', arrTime:'', number:'', car:'', seat:'' };
                    else if (type === 'hotel') form.value = { name:'', address:'', checkIn:'', checkOut:'', bookingRef:'', contact:'', notes:'', image:null };
                    else if (type === 'expense') form.value = { date: new Date().toISOString().split('T')[0], item:'', amount:'', currency: calcCurrency.value, payer: members.value[0], category: 'food', payment: 'cash', splitMode: 'split_all', beneficiary: '', advanceSplits: {} };
                    else if (type === 'ticket_spot') form.value = { name:'', date:'', price:'', currency: 'JPY', image: null };
                    else if (type === 'subway') form.value = { title:'', image: null };
                    else if (type === 'phrase') form.value = { cat: '自訂', jp: '', cn: '', romaji: '' };
                    else if (type === 'daySettings') form.value = { ...tripData.value.days[selectedDayIndex.value] };
                    else form.value = {};
                }

                if (type === 'activity') {
                    nextTick(() => {
                        if(noteInput.value) noteInput.value.innerHTML = form.value.note || '';
                        if(form.value.nextTransport?.isRichText && transportRichInput.value) {
                            transportRichInput.value.innerHTML = form.value.nextTransport.mode || '';
                        }
                    });
                }
            };
            
            const switchToEdit = () => {
                if (modalType.value === 'activity_details') {
                    modalType.value = 'activity';
                    modalTitle.value = '編輯行程';
                    nextTick(() => {
                        if(noteInput.value) noteInput.value.innerHTML = form.value.note || '';
                        if(form.value.nextTransport?.isRichText && transportRichInput.value) {
                            transportRichInput.value.innerHTML = form.value.nextTransport.mode || '';
                        }
                    });
                } else if (modalType.value === 'flight_details') {
                    modalType.value = 'flight';
                    modalTitle.value = '編輯航班';
                } else if (modalType.value === 'memory_details') {
                    modalType.value = 'checkin';
                    modalTitle.value = '編輯打卡';
                    isEditing.value = true;
                }
            };

            const cancelEdit = () => {
                if (modalType.value === 'activity' && isEditing.value) {
                     modalType.value = 'activity_details';
                     modalTitle.value = '行程詳細內容';
                } else if (modalType.value === 'flight' && isEditing.value) {
                     modalType.value = 'flight_details';
                     modalTitle.value = '航班詳細內容';
                } else {
                    closeModal();
                }
            };
            
            const modalTitle = ref('');

            const handleImageUpload = (event, target) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const res = e.target.result;
                    // Direct assignment without cropping
                    if (target === 'day') {
                        tripData.value.days[selectedDayIndex.value].image = res;
                    } else if (target === 'vjw') {
                         tripData.value.vjwImage = res;
                    } else if (target === 'checkin') {
                        form.value.checkInPhoto = res;
                    } else {
                        // activity, subway, ticket_spot, hotel
                        form.value.image = res;
                    }
                    event.target.value = '';
                };
                reader.readAsDataURL(file);
            };

            const addTag = () => { if(!newTagText.value.trim()) return; if(!form.value.tags) form.value.tags = []; form.value.tags.push({ text: newTagText.value, color: newTagColor.value }); newTagText.value = ""; };
            const removeTag = (index) => form.value.tags.splice(index, 1);
            const addExternalLink = () => { if(!form.value.externalLinks) form.value.externalLinks = []; form.value.externalLinks.push({name:'', url:''}); };

            // === SORTING LOGIC (Using SortableJS) ===
            const toggleSort = (key, listRef, listContainerId) => {
                if (isSorting.value[key]) {
                    // SAVE MODE
                    if(sortableInstance) sortableInstance.destroy();
                    isSorting.value[key] = false;
                    saveToLocal();
                } else {
                    // START SORT MODE
                    isSorting.value[key] = true;
                    nextTick(() => {
                        const el = document.getElementById(listContainerId);
                        if (!el) return;
                        
                        sortableInstance = new Sortable(el, {
                            handle: '.drag-handle',
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onEnd: (evt) => {
                                // For basic arrays (Packing, Subway, Flights, Trains, Hotels)
                                if (key !== 'itinerary' && key !== 'memories') {
                                    const item = listRef.value.splice(evt.oldIndex, 1)[0];
                                    listRef.value.splice(evt.newIndex, 0, item);
                                } else if (key === 'itinerary') {
                                    // For Itinerary (Computed Filtered View)
                                    // 1. Get the item that was moved from the current filtered view
                                    const dayItems = [...currentDayItinerary.value]; // Copy of current view state
                                    const movedItem = dayItems.splice(evt.oldIndex, 1)[0];
                                    dayItems.splice(evt.newIndex, 0, movedItem);
                                    
                                    // 2. Reconstruct global itinerary: Keep other days as is, replace current day items with new order
                                    // Filter out current day items from main array
                                    const otherDaysItems = itinerary.value.filter(i => i.dayIndex !== selectedDayIndex.value);
                                    
                                    // 3. Clear and push back. 
                                    // Note: This puts current day items at the end of the main array, which is fine functionally but changes internal order.
                                    // To preserve "Day 1 items before Day 2", we would need more complex logic, but simple append works for display since we filter by dayIndex.
                                    itinerary.value = [...otherDaysItems, ...dayItems];
                                } else if (key === 'memories') {
                                    // For Memories (Computed Filtered View)
                                    // Similar logic: Reorder the subset, then sync back to main list
                                    // This assumes user wants to change display order of memories.
                                    // Since memories are just a view of checked-in itinerary items, reordering them *here* implies reordering them in the main list relative to each other.
                                    const memItems = [...memories.value];
                                    const movedItem = memItems.splice(evt.oldIndex, 1)[0];
                                    memItems.splice(evt.newIndex, 0, movedItem);
                                    
                                    // Identify non-memory items
                                    const nonMemItems = itinerary.value.filter(i => !i.checkedIn);
                                    
                                    // Reconstruct. Note: This loses the chronological interleave of non-checked-in items.
                                    // If strict chronological order matters, this manual sort breaks it. But user asked for manual sort.
                                    itinerary.value = [...nonMemItems, ...memItems];
                                }
                            }
                        })
                    })
                }
            };

            // Replaces moveItem & moveInFilteredList
            const moveItem = (array, index, direction) => { saveToLocal(); };
            const moveInFilteredList = (mainArray, filteredArray, item, direction) => { saveToLocal(); };

            const saveItem = () => {
                const newItem = { ...form.value };
                if (modalType.value !== 'checkin' && (!isEditing.value || !newItem.id)) newItem.id = Date.now().toString(); 

                if (modalType.value === 'daySettings') { Object.assign(tripData.value.days[selectedDayIndex.value], newItem); }
                else if (modalType.value === 'activity') {
                    if (isEditing.value) { 
                        const idx = itinerary.value.findIndex(i => String(i.id) === String(editingId.value)); 
                        if(idx !== -1) itinerary.value[idx] = newItem; 
                        saveToLocal();
                        closeModal();
                        return;
                    }
                    else { newItem.dayIndex = selectedDayIndex.value; newItem.checkedIn = false; itinerary.value.push(newItem); }
                } else if (modalType.value === 'checkin') {
                    const idx = itinerary.value.findIndex(i => String(i.id) === String(newItem.id));
                    if(idx !== -1) { 
                        itinerary.value[idx].checkedIn = true; 
                        itinerary.value[idx].checkInPhoto = newItem.checkInPhoto; 
                        itinerary.value[idx].checkInNote = newItem.checkInNote; 
                        itinerary.value[idx].checkInDate = newItem.checkInDate; 
                        itinerary.value[idx].checkInTime = newItem.checkInTime; 
                        itinerary.value[idx].checkInThoughts = newItem.checkInThoughts; 
                        // Update form so details view reflects changes
                        form.value = { ...itinerary.value[idx] };
                    }
                    modalType.value = 'memory_details';
                    modalTitle.value = '美好的回憶';
                    saveToLocal();
                    return;
                } else if (modalType.value === 'flight') {
                    if(isEditing.value) { 
                        const idx = flights.value.findIndex(f => String(f.id) === String(editingId.value)); 
                        if(idx !== -1) flights.value[idx] = newItem; 
                        const tIdx = collectedTickets.value.findIndex(t => String(t.id) === String(editingId.value)); 
                        if(tIdx !== -1) collectedTickets.value[tIdx] = { ...newItem, type: 'flight' }; 
                        // Removed redirect to flight_details to allow direct close on save
                        saveToLocal();
                        closeModal();
                        return;
                    }
                    else { flights.value.push(newItem); collectedTickets.value.push({ ...newItem, type: 'flight' }); }
                } else if (modalType.value === 'ticket_flight') {
                     if(isEditing.value) { const idx = collectedTickets.value.findIndex(t => String(t.id) === String(editingId.value)); if(idx !== -1) collectedTickets.value[idx] = newItem; }
                     else { newItem.type = 'flight'; collectedTickets.value.push(newItem); }
                } else if (modalType.value === 'trainInfo') {
                    if(isEditing.value) { const idx = trainTickets.value.findIndex(t => String(t.id) === String(editingId.value)); if(idx !== -1) trainTickets.value[idx] = newItem; const tIdx = collectedTickets.value.findIndex(t => String(t.id) === String(editingId.value)); if(tIdx !== -1) collectedTickets.value[tIdx] = { ...newItem, type: 'train' }; }
                    else { trainTickets.value.push(newItem); collectedTickets.value.push({ ...newItem, type: 'train' }); }
                } else if (modalType.value === 'ticket_train') {
                    if(isEditing.value) { const idx = collectedTickets.value.findIndex(t => String(t.id) === String(editingId.value)); if(idx !== -1) collectedTickets.value[idx] = newItem; }
                    else { newItem.type = 'train'; collectedTickets.value.push(newItem); }
                } else if (modalType.value === 'ticket_spot') {
                    if(!newItem.image) { const match = itinerary.value.find(i => i.title.includes(newItem.name) && i.image); if(match) newItem.image = match.image; }
                    if(isEditing.value) { const idx = collectedTickets.value.findIndex(t => String(t.id) === String(editingId.value)); if(idx !== -1) collectedTickets.value[idx] = newItem; }
                    else { newItem.type = 'spot'; collectedTickets.value.push(newItem); }
                } else if (modalType.value === 'hotel') {
                    if(isEditing.value) { const idx = hotels.value.findIndex(h => String(h.id) === String(editingId.value)); if(idx !== -1) hotels.value[idx] = newItem; }
                    else { hotels.value.push(newItem); }
                } else if (modalType.value === 'expense') { expenses.value.push(newItem); }
                else if (modalType.value === 'subway') { subwayMaps.value.push(newItem); }
                else if (modalType.value === 'phrase') { jpPhrases.value.push(newItem); }
                
                saveToLocal(); closeModal();
            };

            const deleteItem = (type, id) => {
                const strId = String(id);
                let isDeleted = false;
                switch (type) {
                    case 'activity': itinerary.value = itinerary.value.filter(i => String(i.id) !== strId); isDeleted = true; break;
                    case 'hotel': hotels.value = hotels.value.filter(i => String(i.id) !== strId); isDeleted = true; break;
                    case 'flight': flights.value = flights.value.filter(i => String(i.id) !== strId); collectedTickets.value = collectedTickets.value.filter(i => String(i.id) !== strId && i.type === 'flight'); isDeleted = true; break;
                    case 'trainInfo': trainTickets.value = trainTickets.value.filter(i => String(i.id) !== strId); collectedTickets.value = collectedTickets.value.filter(i => String(i.id) !== strId && i.type === 'train'); isDeleted = true; break;
                    case 'ticket_spot': case 'ticket_train': case 'ticket_flight': collectedTickets.value = collectedTickets.value.filter(i => String(i.id) !== strId); isDeleted = true; break;
                    case 'expense': expenses.value = expenses.value.filter(i => String(i.id) !== strId); isDeleted = true; break;
                    case 'packing': packingList.value = packingList.value.filter(i => String(i.id) !== strId); isDeleted = true; break;
                    case 'subway': subwayMaps.value = subwayMaps.value.filter(i => String(i.id) !== strId); isDeleted = true; break;
                    case 'phrase': jpPhrases.value = jpPhrases.value.filter(p => String(p.id) !== strId); isDeleted = true; break;
                    case 'memory': const idx = itinerary.value.findIndex(i => String(i.id) === strId); if(idx !== -1) { itinerary.value[idx].checkedIn = false; itinerary.value[idx].checkInPhoto = null; isDeleted = true; } break;
                }
                if (isDeleted) saveToLocal();
            };
            
            const deleteCurrentItem = () => {
                if(!confirm('確定刪除此項目?')) return;
                if (modalType.value === 'daySettings') {
                    const targetIndex = selectedDayIndex.value;
                    removeDay(targetIndex);
                } else {
                    let type = modalType.value;
                    if (type === 'activity_details') type = 'activity';
                    if (type === 'flight_details') type = 'flight';
                    
                    if (type === 'checkin' || type === 'memory_details') {
                         const idx = itinerary.value.findIndex(i => String(i.id) === String(editingId.value));
                         if(idx !== -1) {
                             itinerary.value[idx].checkedIn = false;
                             itinerary.value[idx].checkInPhoto = null;
                             itinerary.value[idx].checkInThoughts = '';
                         }
                         saveToLocal(); closeModal();
                         return;
                    }

                    if (type === 'ticket_flight') type = 'ticket_flight';
                    if (type === 'ticket_train') type = 'ticket_train';
                    if (type === 'ticket_spot') type = 'ticket_spot';
                    if (type === 'trainInfo') type = 'trainInfo';
                    
                    deleteItem(type, editingId.value);
                }
                saveToLocal(); closeModal();
            };

            // ... (Other functions removeDay, toggleMemberDetail etc. unchanged) ...
            const removeDay = (index) => { tripData.value.days.splice(index, 1); itinerary.value = itinerary.value.filter(i => i.dayIndex !== index); itinerary.value.forEach(i => { if (i.dayIndex > index) i.dayIndex--; }); selectedDayIndex.value = Math.max(0, index - 1); saveToLocal(); };
            const toggleMemberDetail = (m) => { if(expandedMember.value === m) expandedMember.value = null; else expandedMember.value = m; };
            const getExpenseBreakdown = (ex) => { const rate = currencyRates.value[ex.currency] || 1; const amountTWD = ex.amount * rate; const payer = ex.payer; let distribution = {}; if (ex.splitMode === 'split_all') { const splitAmt = amountTWD / members.value.length; members.value.forEach(m => distribution[m] = splitAmt); } else if (ex.splitMode === 'self') { distribution[payer] = amountTWD; } else if (ex.splitMode === 'advance') { let totalAllocated = 0; if (ex.advanceSplits) { for (const [m, amt] of Object.entries(ex.advanceSplits)) { const valTWD = amt * rate; distribution[m] = valTWD; totalAllocated += valTWD; } } else if (ex.beneficiary && ex.beneficiary !== payer) { distribution[ex.beneficiary] = amountTWD; totalAllocated = amountTWD; } const remainder = amountTWD - totalAllocated; if (remainder > 0.01) { distribution[payer] = (distribution[payer] || 0) + remainder; } } return { distribution, amountTWD, payer }; };
            const calculateDebts = () => { let debts = {}; members.value.forEach(m1 => members.value.forEach(m2 => { if (m1 !== m2) debts[`${m1}->${m2}`] = 0; })); expenses.value.forEach(ex => { const { distribution, payer } = getExpenseBreakdown(ex); for (const [consumer, cost] of Object.entries(distribution)) { if (consumer !== payer && cost > 0) { debts[`${consumer}->${payer}`] += cost; } } }); return debts; };
            const getMemberTotalConsumption = (m) => { let total = 0; expenses.value.forEach(ex => { const { distribution } = getExpenseBreakdown(ex); total += (distribution[m] || 0); }); return -total; };
            const getSettlementStats = (m) => { const debts = calculateDebts(); let stats = []; members.value.forEach(other => { if (m !== other) { const theyOweMe = debts[`${other}->${m}`] || 0; const iOweThem = debts[`${m}->${other}`] || 0; const net = theyOweMe - iOweThem; if (Math.abs(net) > 1) { stats.push({ name: other, amount: net }); } } }); return stats; };
            const getMemberTransactions = (m) => { let txs = []; expenses.value.forEach(ex => { const { distribution, payer, amountTWD } = getExpenseBreakdown(ex); const myConsumption = -(distribution[m] || 0); let settlementAmount = 0; if (m === payer) { let lent = amountTWD - (distribution[m] || 0); settlementAmount = lent > 0 ? lent : 0; } else { if (distribution[m] > 0) { settlementAmount = -(distribution[m]); } } if (Math.abs(myConsumption) > 0.01 || Math.abs(settlementAmount) > 0.01) { txs.push({ ...ex, myConsumption, settlementAmount, paidBy: payer }); } }); return txs.sort((a,b) => new Date(b.date) - new Date(a.date)); };
            const getMemberBalance = (member) => { const stats = getSettlementStats(member); return stats.reduce((acc, curr) => acc + curr.amount, 0); };
            const toggleAdvanceMember = (m) => { if (!form.value.advanceSplits) form.value.advanceSplits = {}; if (form.value.advanceSplits[m] !== undefined) { delete form.value.advanceSplits[m]; } else { form.value.advanceSplits[m] = null; } };
            const advanceTotal = computed(() => { if (!form.value.advanceSplits) return 0; return Object.values(form.value.advanceSplits).reduce((a, b) => a + (Number(b) || 0), 0); });
            const togglePacking = (idx) => { packingList.value[idx].checked = !packingList.value[idx].checked; saveToLocal(); };
            const deletePacking = (id) => { packingList.value = packingList.value.filter(item => String(item.id) !== String(id)); saveToLocal(); };
            const addPackingItem = () => { if(newPackingItem.value.trim()){ packingList.value.push({id:Date.now().toString(), text:newPackingItem.value, checked:false}); newPackingItem.value=""; saveToLocal(); }};
            const toggleZoom = (e) => { isZoomedIn.value = !isZoomedIn.value; };
            const editDayTitle = () => openModal('daySettings');
            const editActivity = (item) => openModal('activity', item);
            const selectCurrency = (c) => { currencySearch.value = c; calcCurrency.value = c; showCurrencyList.value = false; };
            const locateMe = () => initMap();
            const viewMap = (map) => { zoomedImage.value = map.image; };
// --- ★★★ V4 存檔函式：交通同步版 ★★★ ---
            const saveToLocal = () => {
                if (isRemoteUpdate.value) return;

                // 1. 處理【私有資料】(存手機)
                // 從行程中取出打卡記憶
                const myMemories = {};
                itinerary.value.forEach(item => {
                    if (item.checkedIn || item.checkInPhoto || item.checkInThoughts) {
                        myMemories[item.id] = {
                            checkedIn: item.checkedIn,
                            checkInPhoto: item.checkInPhoto,
                            checkInThoughts: item.checkInThoughts,
                            checkInDate: item.checkInDate,
                            checkInTime: item.checkInTime
                        };
                    }
                });

                const myPrivateData = {
                    packing: packingList.value,
                    flights: flights.value,          // ✈️ 航班 (私有)
                    tickets: collectedTickets.value, // 🎟️ 票券 (私有)
                    memoriesMap: myMemories,         // 📸 回憶 (私有)
                    vjwImage: tripData.value.vjwImage // 🇯🇵 VJW 圖片 (私有)
                    // ★ 注意：trains (交通) 已經移除了，因為要改成共用
                };
                localStorage.setItem('trip_private_v4', JSON.stringify(myPrivateData));

                // 2. 處理【共用資料】(上傳雲端)
                // 清理行程中的打卡隱私
                const cleanItinerary = itinerary.value.map(item => {
                    const { checkedIn, checkInPhoto, checkInThoughts, checkInDate, checkInTime, ...publicPlan } = item;
                    return publicPlan;
                });

                // 清理 tripData (移除 VJW)
                const publicTripData = { ...tripData.value };
                delete publicTripData.vjwImage; 

                const sharedData = {
                    trip: publicTripData,
                    itinerary: cleanItinerary,
                    hotels: hotels.value,          // 🏨 飯店 (同步)
                    expenses: expenses.value,      // 💰 記帳 (同步)
                    maps: subwayMaps.value,        // 🗺️ 地圖 (同步)
                    phrases: jpPhrases.value,      // 🗣️ 單字 (同步)
                    trains: trainTickets.value,    // 🚆 交通 (同步！從私有移來這裡)
                    lastUpdated: new Date().toISOString()
                };

                db.ref(tripId).set(sharedData).catch(err => {
                    console.error("同步失敗:", err);
                });
            };

            const generateAITip = () => { const tips = ["嵐山小火車建議提前一個月預訂", "清水寺周邊坂道多建議穿好走的鞋", "搭乘公車通常後門上車前門付款", "USJ 快速通關券建議開賣當天搶購"]; tripData.value.days[selectedDayIndex.value].tips = tips[Math.floor(Math.random() * tips.length)]; };
            const sendAIMessage = () => {
                const text = aiInput.value.trim();
                if (!text) return;
                aiMessages.value.push({ role: 'user', text });
                aiInput.value = '';
                isAiThinking.value = true;
                nextTick(() => { const box = document.getElementById('aiChatBox'); if(box) box.scrollTop = box.scrollHeight; });
                setTimeout(() => {
                    let reply = '收到，這是一個很棒的提議。作為您的管家，我會建議您留意當地的營業時間。';
                    if (text.includes('天氣')) reply = '近期關西地區早晚溫差較大，建議您攜帶薄外套。若前往京都山區，氣溫會再低一些。';
                    else if (text.includes('交通') || text.includes('地鐵')) reply = '在大阪，地鐵是最便捷的交通方式；前往京都各景點則推薦利用巴士或電車。建議您準備好 ICOCA 卡，能讓旅程更順暢。';
                    else if (text.includes('吃') || text.includes('美食')) reply = '大阪是「天下的廚房」，章魚燒與大阪燒不可錯過；京都則以精緻的懷石料理與湯豆腐聞名。請問您偏好哪種類型的料理呢？';
                    else if (text.includes('環球') || text.includes('USJ')) reply = '前往環球影城建議提早入園。若您計畫進入任天堂世界，請務必確認是否需要整理券，管家可以為您留意相關資訊。';
                    else if (text.includes('你好') || text.includes('嗨')) reply = '您好！祝您在關西的旅途愉快順心。有任何吩咐請隨時告訴我。';
                    aiMessages.value.push({ role: 'ai', text: reply });
                    isAiThinking.value = false;
                    nextTick(() => { const box = document.getElementById('aiChatBox'); if(box) box.scrollTop = box.scrollHeight; });
                }, 1500);
            };
            // ... (Sticker Logic) ...
            const stickers = ['🌸', '⛩️', '🍱', '🍵', '🦌', '🚄', '🏯', '✨', '🍙', '🍁', '📸', '🎋', '🎏', '👺', '🐙', '🦀', '🍜', '🚌'];
            const getPseudoRandom = (input) => { let hash = 0; const str = String(input); for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); } return Math.abs(hash); };
            const getPolaroidStyle = (id) => { const seed = getPseudoRandom(id); const rotate = (seed % 10) - 5; return { transform: `rotate(${rotate}deg)` }; };
            const getSticker = (id) => { const seed = getPseudoRandom(id); return stickers[seed % stickers.length]; };
            const getStickerStyle = (id) => { const seed = getPseudoRandom(id); const rotate = (seed % 60) - 30; return { transform: `rotate(${rotate}deg)` }; };

// --- ★★★ V4 啟動函式：從雲端抓取交通資訊 ★★★ ---
            onMounted(() => {
                // 1. 讀取私有資料
                let localMemoriesMap = {};
                let localVJW = null;
                
                try {
                    // 注意：key 改成 v4 以免讀到舊格式混亂
                    const localSaved = localStorage.getItem('trip_private_v4'); 
                    if (localSaved) {
                        const d = JSON.parse(localSaved);
                        packingList.value = d.packing || [];
                        flights.value = d.flights || [];
                        // trains 已經不讀這裡了
                        collectedTickets.value = d.tickets || [];
                        localMemoriesMap = d.memoriesMap || {};
                        localVJW = d.vjwImage;
                        
                        if (localVJW) tripData.value.vjwImage = localVJW;
                    }
                } catch (e) { console.error("Local Load Error", e); }

                // 2. 監聽雲端
                const dataRef = db.ref(tripId);
                
                dataRef.on('value', (snapshot) => {
                    const remoteData = snapshot.val();
                    if (remoteData) {
                        isRemoteUpdate.value = true;

                        // 更新 TripData (保護本地 VJW)
                        const currentVJW = tripData.value.vjwImage; 
                        tripData.value = remoteData.trip || tripData.value;
                        if (currentVJW) tripData.value.vjwImage = currentVJW;
                        else if (localVJW) tripData.value.vjwImage = localVJW;

                        // 同步項目
                        hotels.value = remoteData.hotels || [];
                        expenses.value = remoteData.expenses || [];
                        subwayMaps.value = remoteData.maps || [];
                        jpPhrases.value = remoteData.phrases || jpPhrases.value;
                        trainTickets.value = remoteData.trains || []; // ★ 交通資訊從雲端讀取

                        // 合併行程與打卡記憶
                        const cloudItinerary = remoteData.itinerary || [];
                        itinerary.value = cloudItinerary.map(plan => {
                            const myMemory = localMemoriesMap[plan.id];
                            if (myMemory) return { ...plan, ...myMemory };
                            return plan;
                        });

                        fetchRates();
                        if(currentTab.value === 'itinerary') setTimeout(initMap, 500);

                        nextTick(() => {
                            isRemoteUpdate.value = false;
                        });
                    }
                });
                
                setTimeout(initMap, 500);
            });

            return {
                // 狀態變數
                currentTab, selectedDayIndex, showModal, modalType, modalTitle, form, isEditing,
                tripData, itinerary, flights, hotels, expenses, packingList, subwayMaps, trainTickets, collectedTickets,
                currentDayData, currentDayItinerary, weatherForecast5Days, memories,
                members, expandedMember, newPackingItem,
                currencyRates, calcCurrency, calcAmount, currencySearch, showCurrencyList, filteredCurrencies, modalCurrencySearch, showModalCurrency, modalFilteredCurrencies, totalExpenseTWD,
                groupedTickets, airlineData,
                aiInput, aiMessages, isAiThinking, zoomedImage, isZoomedIn,
                newTagText, newTagColor, noteInput, transportRichInput, showJPHelp, jpPhrases, focusedPhrase,
                
                // 功能函式
                addDay, openModal, closeModal, saveItem, removeDay, selectDay,
                handleImageUpload, editDayTitle, editActivity,
                addExternalLink, toggleZoom, viewMap, locateMe, sendAIMessage, generateAITip, fetchRates, selectCurrency,
                addTag, removeTag, switchToEdit, cancelEdit, toggleCheckIn, openCheckInModal,
                toggleMemberDetail, addPackingItem, togglePacking, deletePacking, handleTouchStart, handleTouchMove, handleTouchEnd,
                
                // ★★★ 這是新的刪除函式，一定要有這行！ ★★★
                killItem,  showDeleteConfirm, // 控制確認視窗顯示
                executeDelete, deleteItem,

                // Helper Functions
                getTypeIcon, getDayIcon, getTagStyle, getTransportColor, getWeatherCityForDay, getStampIcon,
                getAirlineLogo, getAirlineStyle, getTrainClass, getTypeColor,
                getPolaroidStyle, getSticker, getStickerStyle, getPseudoRandom,
                expenseTypes, paymentMethods, splitModes,
                toggleAdvanceMember, advanceTotal, getMemberTransactions, getMemberTotalConsumption, getSettlementStats,
                viewMemory,
                
                // Sorting
                moveItem, moveInFilteredList, isSorting, toggleSort
            };      
      }
    }).mount('#app');
</script>
</body>
</html>